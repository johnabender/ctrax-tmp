<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head>


<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="robots" content="index,nofollow">


<title>Ctrax - The Caltech Multiple Walking Fly Tracker</title>

<link rel="stylesheet" type="text/css" charset="utf-8" media="all" 
href="ctrax_files/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" 
href="ctrax_files/screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" 
href="ctrax_files/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" 
media="projection" href="ctrax_files/projection.css">
</head><body dir="ltr" lang="en">

<div id="title" dir="ltr" lang="en">
<table width="100%" border="0">
  <tr>
    <td><img src="images/ctrax-logo2b_128.png" width="128" height="128" alt="Ctrax logo"></td>
    <td><h1>Ctrax: The Caltech Multiple Walking Fly Tracker</h1></td>
  </tr>
</table>
</div>

<div id="page" dir="ltr" lang="en"><!-- start page -->
<div id="content" dir="ltr" lang="en">
<!--<a id="top"></a>
<a class="reference" href="http://www.hhmi.org/research/fellows/branson_bio.html">Kristin
 Branson</a>, <a class="reference" 
href="mailto:robiea@janelia.hhmi.org">Alice Robie</a>, <a
 class="reference" href="http://roach.biol.cwru.edu/JohnBender">John 
Bender</a>, <a class="reference" 
href="http://www.biology.washington.edu/users/michael-dickinson">Michael 
Dickinson</a>, <a class="reference" 
href="http://www.vision.caltech.edu/Perona.html">Pietro Perona</a></p>-->
<p>Ctrax is an open-source, 
freely available machine vision program for estimating the positions 
and orientations of many walking flies, maintaining their individual 
identities over long periods of time. It was designed to allow 
high-throughput, quantitative analysis of behavior in freely moving 
flies. Our primary goal in this project is to provide quantitative 
behavior analysis tools to the neuroethology community; thus, we've 
endeavored to make the system adaptable to other labs' setups. We have 
assessed the quality of the tracking results for our setup, and found 
that it can maintain fly identities indefinitely with minimal 
supervision, and on average for 1.5 fly-hours automatically.</p>
<p>To further compensate for identity and other tracking errors, we 
provide the FixErrors 
Matlab GUI that identifies suspicious sequences of frames and allows
 a user to correct any tracking errors. We also distribute the BehavioralMicroarray
 Matlab Toolbox for defining and detecting a broad palette of 
individual and social behaviors. This software inputs the trajectories 
output by Ctrax and computes descriptive statistics of the behavior of 
each individual fly. We provide software for three proof-of-concept 
experiments to show the potential of the Ctrax software and our behavior
 detectors.</p>
<p>This package is described in the article "High-Throughput
 Ethomics in Large Groups of <i>Drosophila</i>," Branson et al., <i>Nature Methods</i>, 2009 (<a class="reference" 
href="http://dx.doi.org/10.1038/nmeth.1328">DOI:10.1038/nmeth.1328</a>).</p>

<hr class="h2-divider"><h2>Contents</h2>

<ul>
  <li><a class="reference" href="#download" id="id2" name="id2">Download</a></li>
  <li><a class="reference" href="#mailing-list" id="id3" name="id3">Mailing
 List</a></li>
  <li><a class="reference" href="#ctrax" id="id4" name="id4">Ctrax</a>
  <ul>
    <li><a class="reference" href="#ctrax-requirements" id="id5" 
name="id5">Ctrax Requirements</a>
    <ul>
      <li><a class="reference" 
href="#ctrax-computer-and-software-requirements" id="id6" name="id6">Ctrax
 Computer and Software Requirements</a></li>
      <li><a class="reference" href="#ctrax-input-video-formats" id="id7" 
name="id7">Ctrax Input Video Formats</a>
      <ul>
        <li><a class="reference" href="#uncompressed-avi-format" id="id8" 
name="id8">Uncompressed AVI Format</a></li>
        <li><a class="reference" href="#fly-movie-format" id="id9" name="id9">Fly
 Movie Format</a></li>
        <li><a class="reference" href="#static-background-fly-movie-format" 
id="id10" name="id10">Static Background Fly Movie Format</a></li>
        <li><a class="reference" href="#micro-fly-movie-format" id="id11" 
name="id11">Micro Fly Movie Format</a></li>
      </ul>
      </li>
      <li><a class="reference" href="#ctrax-arena-and-video-requirements" 
id="id12" name="id12">Ctrax Arena and Video Requirements</a>
      <ul>
        <li><a class="reference" href="#background-subtraction-considerations" 
id="id13" name="id13">Background Subtraction Considerations</a></li>
        <li><a class="reference" href="#constant-velocity-considerations" 
id="id14" name="id14">Constant Velocity Considerations</a></li>
        <li><a class="reference" href="#splitting-and-merging-connected-components" id="id15" name="id15">Splitting
 and Merging Connected Components</a></li>
        <li><a class="reference" href="#escaping-and-entering-flies" id="id16" 
name="id16">Escaping and Entering Flies</a></li>
      </ul>
      </li>
    </ul>
    </li>
    <li><a class="reference" href="#ctrax-installation" id="id17" 
name="id17">Ctrax Installation</a>
    <ul>
      <li><a class="reference" href="#ctrax-installation-windows-installer" 
id="id18" name="id18">Ctrax Installation: Windows Installer</a></li>
      <li><a class="reference" href="#ctrax-installation-ubuntu-package" 
id="id19" name="id19">Ctrax Installation: Ubuntu Package</a></li>
      <li><a class="reference" href="#ctrax-installation-distutils" 
id="id20" name="id20">Ctrax Installation: DistUtils</a>
      <ul>
        <li><a class="reference" href="#ctrax-python-dependencies" id="id21" 
name="id21">Ctrax Python Dependencies</a></li>
      </ul>
      </li>
    </ul>
    </li>
    <li><a class="reference" href="#ctrax-usage" id="id22" name="id22">Ctrax
 Usage</a>
    <ul>
      <li><a class="reference" href="#ctrax-settings-background-model" 
id="id23" name="id23">Ctrax Settings-&gt;Background Model...</a></li>
      <li><a class="reference" href="#ctrax-settings-background-subtraction" 
id="id24" name="id24">Ctrax Settings-&gt;Background Subtraction...</a></li>
      <li><a class="reference" href="#ctrax-settings-tracking-settings" 
id="id25" name="id25">Ctrax Settings-&gt;Tracking Settings...</a>
      <ul>
        <li><a class="reference" 
href="#ctrax-tracking-settings-shape-parameters" id="id26" name="id26">Ctrax
 Tracking Settings Shape Parameters</a></li>
        <li><a class="reference" 
href="#ctrax-tracking-settings-motion-parameters" id="id27" name="id27">Ctrax
 Tracking Settings Motion Parameters</a></li>
        <li><a class="reference" href="#ctrax-tracking-settings-observation-parameters" id="id28" 
name="id28">Ctrax Tracking Settings Observation Parameters</a></li>
        <li><a class="reference" href="#ctrax-tracking-settings-hindsight-parameters" id="id29" 
name="id29">Ctrax Tracking Settings Hindsight Parameters</a></li>
      </ul>
      </li>
      <li><a class="reference" href="#ctrax-track-start-tracking" id="id30" 
name="id30">Ctrax Track-&gt;Start Tracking</a></li>
      <li><a class="reference" href="#ctrax-track-choose-orientations" 
id="id31" name="id31">Ctrax Track-&gt;Choose Orientations...</a></li>
      <li><a class="reference" href="#ctrax-file-export-as-mat-file" id="id32"
 name="id32">Ctrax File-&gt;Export as MAT-file...</a></li>
      <li><a class="reference" href="#ctrax-display-control" id="id33" 
name="id33">Ctrax Display Control</a></li>
      <li><a class="reference" href="#ctrax-batch-processing" id="id34" 
name="id34">Ctrax Batch Processing</a></li>
      <li><a class="reference" href="#ctrax-other-commands" id="id35" 
name="id35">Ctrax Other Commands</a></li>
    </ul>
    </li>
    <li><a class="reference" href="#example-video-annotation-and-mat-files" 
id="id36" name="id36">Example Video, Annotation, and Mat files</a></li>
  </ul>
  </li>
  <li><a class="reference" href="#fixerrors-matlab-gui" id="id37" 
name="id37">FixErrors Matlab GUI</a>
  <ul>
    <li><a class="reference" href="#fixerrors-requirements" id="id38" 
name="id38">FixErrors Requirements</a></li>
    <li><a class="reference" href="#fixerrors-installation" id="id39" 
name="id39">FixErrors Installation</a></li>
    <li><a class="reference" href="#fixerrors-usage" id="id40" 
name="id40">FixErrors Usage</a>
    <ul>
      <li><a class="reference" href="#fixerrors-start-up" id="id41" 
name="id41">FixErrors Start-Up</a></li>
      <li><a class="reference" href="#fixerrors-suspiciousness-parameters" 
id="id42" name="id42">FixErrors Suspiciousness Parameters</a></li>
      <li><a class="reference" href="#fixerrors-gui-display" id="id43" 
name="id43">FixErrors GUI Display</a></li>
      <li><a class="reference" href="#fixerrors-manipulating-trajectories" 
id="id44" name="id44">FixErrors Manipulating Trajectories</a>
      <ul>
        <li><a class="reference" href="#fixerrors-edit-tools-delete-track" 
id="id45" name="id45">FixErrors Edit Tools: Delete Track</a></li>
        <li><a class="reference" href="#fixerrors-edit-tools-swap-identities" 
id="id46" name="id46">FixErrors Edit Tools: Swap Identities</a></li>
        <li><a class="reference" href="#fixerrors-edit-tools-connect-tracks" 
id="id47" name="id47">FixErrors Edit Tools: Connect Tracks</a></li>
        <li><a class="reference" href="#fixerrors-edit-tools-interpolate" 
id="id48" name="id48">FixErrors Edit Tools: Interpolate</a></li>
        <li><a class="reference" href="#fixerrors-edit-tools-extend-track" 
id="id49" name="id49">FixErrors Edit Tools: Extend Track</a></li>
        <li><a class="reference" href="#fixerrors-edit-tools-auto-track" 
id="id50" name="id50">FixErrors Edit Tools: Auto Track</a></li>
        <li><a class="reference" href="#fixerrors-edit-tools-flip-orientation" 
id="id51" name="id51">FixErrors Edit Tools: Flip Orientation</a></li>
        <li><a class="reference" 
href="#fixerrors-edit-tools-auto-track-multiple" id="id52" name="id52">FixErrors
 Edit Tools: Auto Track Multiple</a></li>
      </ul>
      </li>
    </ul>
    </li>
  </ul>
  </li>
  <li><a class="reference" href="#behavioralmicroarray-matlab-toolbox" 
id="id53" name="id53">BehavioralMicroarray Matlab Toolbox</a>
  <ul>
    <li><a class="reference" href="#behavioralmicroarray-requirements" 
id="id54" name="id54">BehavioralMicroarray Requirements</a></li>
    <li><a class="reference" href="#behavioralmicroarray-installation" 
id="id55" name="id55">BehavioralMicroarray Installation</a></li>
    <li><a class="reference" href="#behavioralmicroarray-usage" id="id56"
 name="id56">BehavioralMicroarray Usage</a>
    <ul>
      <li><a class="reference" href="#showtrx-m" id="id57" name="id57">showtrx.m</a></li>
      <li><a class="reference" href="#simple-diagnostics-m" id="id58" 
name="id58">simple_diagnostics.m</a></li>
      <li><a class="reference" href="#make-ctrax-results-movie-m" id="id59" 
name="id59">make_ctrax_results_movie.m</a></li>
      <li><a class="reference" href="#load-tracks-m" id="id60" name="id60">load_tracks.m</a></li>
      <li><a class="reference" href="#convert-units-m" id="id61" name="id61">convert_units.m</a></li>
      <li><a class="reference" href="#compute-perframe-stats-m" id="id62" 
name="id62">compute_perframe_stats.m</a></li>
      <li><a class="reference" href="#compute-perframe-stats-social-m" 
id="id63" name="id63">compute_perframe_stats_social.m</a></li>
      <li><a class="reference" href="#classify-by-area-m" id="id64" 
name="id64">classify_by_area.m</a></li>
      <li><a class="reference" href="#learn-params-m" id="id65" name="id65">learn_params.m</a></li>
      <li><a class="reference" href="#learn-params-social-m" id="id66" 
name="id66">learn_params_social.m</a></li>
      <li><a class="reference" href="#detect-behaviors-m" id="id67" 
name="id67">detect_behaviors.m</a></li>
      <li><a class="reference" href="#histogramproperties-m" id="id68" 
name="id68">histogramproperties.m</a></li>
      <li><a class="reference" href="#plot-behaviormicroarray-m" id="id69" 
name="id69">plot_behaviormicroarray.m</a></li>
    </ul>
    </li>
  </ul>
  </li>
  <li><a class="reference" href="#ctrax-matlab-toolboxes-installation" 
id="id70" name="id70">Ctrax Matlab Toolboxes Installation</a></li>
  <li><a class="reference" href="#contact" id="id71" name="id71">Contact</a></li>
</ul>
</div>

<hr class="h2-divider">
<h2>Download</h2>
<div class="section">
<ul>
<li>All software is available from our distribution site: <a 
class="reference" href="http://developer.berlios.de/projects/ctrax/">berliOS
 Ctrax Project Summary</a>.</li>
<li><a class="reference" href="#ctrax">Ctrax</a> tracking software:</li>
</ul>
<blockquote>
<ul>
<li>The development version of the software can be checked out using <a 
class="reference" href="http://subversion.tigris.org/">Subversion</a> by
 following the instructions at <a class="reference" 
href="http://developer.berlios.de/svn/?group_id=10360">Ctrax SVN 
Instructions</a>.</li>
<li><em>Windows</em>: A 32-bit installer for the <a class="reference" 
href="#ctrax">Ctrax</a> tracker is available at <a class="reference" 
href="http://prdownload.berlios.de/ctrax/Ctrax-0.1.5.6-installer.exe">Ctrax
 Win32 Installer Latest Release</a>. Please follow the instructions at <a
 class="reference" href="#ctrax-installation-windows-installer">Ctrax 
Installation: Windows Installer</a>.</li>
<li><em>Ubuntu</em>: 32- and 64-bit <a class="reference" 
href="http://www.debian.org/distrib/packages">Debian packages</a> for 
the <a class="reference" href="#ctrax">Ctrax</a> tracker are available 
at <a class="reference" href="http://debs.astraw.com/">Andrew Straw's 
Apt Repository</a>. Please follow the instructions at <a 
class="reference" href="#ctrax-installation-ubuntu-package">Ctrax 
Installation: Ubuntu Package</a>.</li>
<li><em>Source code</em>: The <a class="reference" href="#ctrax">Ctrax</a>
 tracker source code is available at <a class="reference" 
href="http://prdownload.berlios.de/ctrax/Ctrax-0.1.5.6.zip">Ctrax Source
 Latest Release</a>. Please follow the instructions at <a 
class="reference" href="#ctrax-installation-distutils">Ctrax 
Installation: DistUtils</a>.</li>
</ul>
</blockquote>
<ul>
<li>Matlab Toolboxes:</li>
</ul>
<blockquote>
<ul>
<li>The <a class="reference" href="#fixerrors-matlab-gui">FixErrors 
Matlab GUI</a> and <a class="reference" 
href="#behavioralmicroarray-matlab-toolbox">BehavioralMicroarray Matlab 
Toolbox</a> can be downloaded together from <a class="reference" 
href="http://prdownload.berlios.de/ctrax/Ctrax-allmatlab-0.1.04.zip">Ctrax
 Matlab Toolboxes Latest Release</a>. Please follow instructions at <a 
class="reference" href="#ctrax-matlab-toolboxes-installation">Ctrax 
Matlab Toolboxes Installation</a>.</li>
<li>The <a class="reference" href="#fixerrors-matlab-gui">FixErrors 
Matlab GUI</a> alone can be downloaded at <a class="reference" 
href="http://prdownload.berlios.de/ctrax/fixerrors-0.1.04.zip">FixErrors
 Matlab GUI Latest Release</a>. Please follow instructions at <a 
class="reference" href="#fixerrors-installation">FixErrors Installation</a>.</li>
<li>The <a class="reference" href="#behavioralmicroarray-matlab-toolbox">BehavioralMicroarray
 Matlab Toolbox</a> alone can be downloaded at <a class="reference" 
href="http://prdownload.berlios.de/ctrax/behavioranalysis-0.1.04.zip">BehavioralMicroarray
 Matlab Toolbox Latest Release</a>. Please follow the instructions at <a
 class="reference" href="#behavioralmicroarray-installation">BehavioralMicroarray
 Installation</a>.</li>
</ul>
</blockquote>
</div>
<hr class="docutils">
<div class="section">
<h2><a class="toc-backref" href="#id3" id="mailing-list" 
name="mailing-list">Mailing List</a></h2>
<p>Users and developers of Ctrax can join the <a class="reference" 
href="http://groups.google.com/group/ctrax">Ctrax Google Group</a>. 
Here, we will post announcements and descriptions of new releases, as 
well as discuss bugs, usage, and feature requests.</p>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id4" id="ctrax" name="ctrax">Ctrax</a></h2>
<p>Ctrax, the Caltech Multiple Fly Tracker, is an open-source tracking 
program for following a large population of flies interacting in a 
planar arena. Ctrax inputs a stored video sequence of the interacting 
flies and computes the trajectory of each fly (center position and 
orientation in each frame), preserving identity. Ctrax also incorporates
 a GUI for visualizing and setting various parameters of the tracking 
algorithm, allowing it to adapt to different experimental set-ups.</p>
<p>We have extensively groundtruthed the accuracy of the tracker for our
 apparatus. These results are described in our article <a 
class="reference" 
href="http://www.nature.com/nmeth/journal/vaop/ncurrent/abs/nmeth.1328.html">High-Throughput
 Ethomics in Large Groups of Drosophila</a>.</p>
<div class="section">
<h3><a class="toc-backref" href="#id5" id="ctrax-requirements" 
name="ctrax-requirements">Ctrax Requirements</a></h3>
<p>Ctrax is Python-based, and it and all dependent software are 
open-source and (somewhat) platform-independent. A description of the 
computer hardware and software requirements for Ctrax is given in <a 
class="reference" href="#ctrax-computer-and-software-requirements">Ctrax
 Computer and Software Requirements</a>. Installation and usage 
instructions are given at <a class="reference" 
href="#ctrax-installation">Ctrax Installation</a> and <a 
class="reference" href="#ctrax-usage">Ctrax Usage</a>. An overview of 
the video and physical arena requirements is given in <a 
class="reference" href="#ctrax-arena-and-video-requirements">Ctrax Arena
 and Video Requirements</a>.</p>
<div class="section">
<h4><a class="toc-backref" href="#id6" 
id="ctrax-computer-and-software-requirements" 
name="ctrax-computer-and-software-requirements">Ctrax Computer and 
Software Requirements</a></h4>
<p>Ctrax has been installed and tested on 32-bit Windows and 32- and 
64-bit Linux systems. As it is written in Python and Python is a 
platform-independent language, it conceivably can be run on other 
platforms as well. Installation instructions are at <a class="reference"
 href="#ctrax-installation">Ctrax Installation</a>. Memory usage is not 
demanding for reasonably short videos -- all that is needed is enough 
memory to store the ellipse fit for each fly in each frame. Ctrax will 
run faster on faster computers, but has no minimal speed requirements.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id7" id="ctrax-input-video-formats" 
name="ctrax-input-video-formats">Ctrax Input Video Formats</a></h4>
<p>Ctrax versions ≥ 0.1.4 uses <a class="reference" 
href="http://www.ffmpeg.org/">FFmpeg</a> (via <a class="reference" 
href="http://www.pyglet.org/">Pyglet</a>'s <a class="reference" 
href="http://code.google.com/p/avbin/">avbin</a> wrapper) to read many 
types of movie files and codecs. The formats supported by <a 
class="reference" href="http://www.ffmpeg.org/">FFmpeg</a> are described
 at <a class="reference" href="http://www.ffmpeg.org/general.html#SEC3">FFmpeg
 Supported File Formats and Codecs</a>. Depending on the type and 
parameters of the video compression, Ctrax may be slow and inexact at 
allowing out-of-order frame access (used by the GUIs). While Ctrax may 
be able to read a given file format, it may not be able to successfully 
track the flies if compression artifacts are too prevalent. All our 
experiments were performed using <a class="reference" 
href="#fly-movie-format">Fly Movie Format</a> and <a class="reference" 
href="#static-background-fly-movie-format">Static Background Fly Movie 
Format</a> videos. Older versions of Ctrax only support <a 
class="reference" href="#uncompressed-avi-format">Uncompressed AVI 
Format</a> video, <a class="reference" href="#fly-movie-format">Fly 
Movie Format</a> (FMF) video, or <a class="reference" 
href="#static-background-fly-movie-format">Static Background Fly Movie 
Format</a> (SBFMF) video.</p>
<div class="section">
<h5><a class="toc-backref" href="#id8" id="uncompressed-avi-format" 
name="uncompressed-avi-format">Uncompressed AVI Format</a></h5>
<p>The AVI container is rather poorly defined, and our AVI reader has 
only been tested with the uncompressed AVIs output by <a 
class="reference" href="http://www.mathworks.com/">Matlab</a>, <a 
class="reference" href="http://en.wikipedia.org/wiki/MEncoder">mencoder</a>,
 and <a class="reference" href="http://en.wikipedia.org/wiki/VirtualDub">VirtualDub</a>.
 To convert any movie type to an uncompressed AVI using <a 
class="reference" href="http://en.wikipedia.org/wiki/VirtualDub">VirtualDub</a>:</p>
<ol>
<li>Start VirtualDub program.</li>
<li>Open compressed video (File-&gt;Open video file...).</li>
<li>In the dialog opened from Video-&gt;Compression..., select 
"[Uncompressed RGB/YCbCr]", and click "OK".</li>
<li>Select Video-&gt;Full Processing Mode.</li>
<li>Select Audio-&gt;No audio.</li>
<li>In the Video-&gt;Video Color Depth dialog, select "Luminance only 
(Y8)" as the "Output format to compressor/display". [Ctrax currently 
only works in grayscale. Color movies can be read, but color information
 is ignored. Ctrax also works if "24 bit RGB (888)" is selected as the 
color depth.]</li>
<li>Output uncompressed video to a file: File-&gt;Save as AVI...</li>
</ol>
<p>To convert any movie type to an uncompressed AVI using <a 
class="reference" href="http://en.wikipedia.org/wiki/MEncoder">mencoder</a>,
 use the following command:</p>
<blockquote>
<tt>mencoder compressedmovie.avi -o uncompressedmovie.avi -vf 
format=rgb24 -ovc raw -nosound</tt></blockquote>
<p>where <tt>compressedmovie.avi</tt> is the name of the compressed 
movie and <tt>uncompressedmovie.avi</tt> is the name of the output 
uncompressed movie. Currently, the tracker converts the RGB video into 
grayscale, ignoring all hue information.</p>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id9" id="fly-movie-format" 
name="fly-movie-format">Fly Movie Format</a></h5>
<p><a class="reference" 
href="http://code.astraw.com/projects/motmot/fly-movie-format.html">Motmot's
 Fly Movie Format</a> (FMF) is the uncompressed movie format output by <a
 class="reference" 
href="http://code.astraw.com/projects/motmot/fview.html">fview</a>, the 
program we use to capture uncompressed, high-resolution, high-frame rate
 video in our lab.</p>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id10" 
id="static-background-fly-movie-format" 
name="static-background-fly-movie-format">Static Background Fly Movie 
Format</a></h5>
<p>Static Background Fly Movie Format (SBFMF) is a compressed video 
format designed to work well with background subtraction-based tracking 
algorithms. It stores the static background model for the entire video, 
then only the pixel intensities and locations for those pixels in a 
frame that are sufficiently different from the background model. We 
achieved 100x compression without affecting tracking results using this 
format. Ctrax can optionally output an SBFMF while tracking so that this
 smaller file can be stored and transferred instead of the original 
uncompressed video.</p>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id11" id="micro-fly-movie-format" 
name="micro-fly-movie-format">Micro Fly Movie Format</a></h5>
<p>Ctrax versions ≥ 0.1.5.5 support Micro Fly Movie Format (UFMF) movies
 as well. This format is similar to SBFMF, but can be saved on-the-fly 
by fview.</p>
</div>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id12" 
id="ctrax-arena-and-video-requirements" 
name="ctrax-arena-and-video-requirements">Ctrax Arena and Video 
Requirements</a></h4>
<a class="reference image-reference" 
href="http://download.berlios.de/ctrax/resultsmovie_25F25M_2min_20071009_164618_xvid20MB.avi"><div
 class="align-center" align="center"><img alt="25 female and 25 male 
flies in 24.5-cm diameter open arena." class="align-center" 
src="ctrax_files/ctrax_003.jpg" style="width: 400px;"></div>
</a>
<p><em>25 female and 25 male wild-type flies in a 24.5-cm diameter open 
arena. Video is recorded at 20 fps in near-IR, hence the flies appear as
 white specs on a black background. Flies are approximately 8 pixels in 
length. Their wings have been clipped to keep them from flying, and a 
heat barrier restricts them from climbing the arena walls.</em></p>
<p>A description of the tracking algorithm and the apparatuses we used 
it with is given in the article <a class="reference" 
href="http://www.nature.com/nmeth/journal/vaop/ncurrent/abs/nmeth.1328.html">High-Throughput
 Ethomics in Large Groups of Drosophila</a>. Next, we discuss briefly 
the assumptions made by the algorithm, and the constraints they put on 
the physical arena setup. Here are links to videos of tracking results 
in our two arena types:</p>
<ul>
<li><a class="reference" 
href="http://download.berlios.de/ctrax/resultsmovie_25F25M_2min_20071009_164618_xvid20MB.avi">25
 female and 25 male wild-type flies in open arena</a></li>
<li><a class="reference" 
href="http://download.berlios.de/ctrax/resultsmovie_50F00M_2min_20071009_155327_xvid16MB.avi">50
 female wild-type flies in open arena</a></li>
<li><a class="reference" 
href="http://download.berlios.de/ctrax/resultsmovie_00F50M_2min_20071009_161603_xvid20MB.avi">50
 male wild-type flies in open arena</a></li>
<li><a class="reference" 
href="http://download.berlios.de/ctrax/openarena_fru1fru1_20090306_213758_xvid30MB.avi">20
 male fru1/fru1 flies in open arena</a></li>
<li><a class="reference" 
href="http://download.berlios.de/ctrax/flybowl_fru1fru1_20090301_204358_xvid_30MB.avi">14
 male fru1/fru1 flies in covered chamber</a></li>
<li><a class="reference" 
href="http://download.berlios.de/ctrax/flybowl_wildtype_20090302_220732_xvid_30MB.avi">14
 male wild-type flies in covered chamber</a></li>
</ul>
<p>Please contact <a class="reference" 
href="http://www.hhmi.org/research/fellows/branson.html">Kristin Branson</a> 
if you have successfully applied Ctrax in your experimental set-up and 
have a video to share.</p>
<a class="reference image-reference" 
href="http://download.berlios.de/ctrax/flybowl_fru1fru1_20090301_204358_xvid_30MB.avi"><div
 class="align-center" align="center"><img alt="14 male fru1/fru1 flies 
in &quot;Flybowl&quot; covered arena." class="align-center" 
src="ctrax_files/ctrax_012.png" style="width: 400px;"></div>
</a>
<p><em>14 male fruitless flies in a 5-in diameter chamber with glass 
top. Video is recorded at 20 fps in the visible spectrum, and flies 
appear as black specs on a white background. Flies are approximately 
17.5 pixels in length. Their wings have *not</em> been clipped.*</p>
<div class="section">
<h5><a class="toc-backref" href="#id13" 
id="background-subtraction-considerations" 
name="background-subtraction-considerations">Background Subtraction 
Considerations</a></h5>
<p>Ctrax is based on background subtraction. It estimates a static model
 of what the
arena looks like without flies, then classifies pixels in each frame
as foreground (belonging to a fly) or background (belonging to the
arena) based on the difference between the current frame and the
background model. Thus, there must not be anything moving or changing
appearance in the video other than the flies [note: using the Ctrax
GUI, the user can specify pixel locations to ignore changes in and
always classify as background, relaxing this assumption slightly].
Flickering lights, for example, cause big changes in background
appearance, and Ctrax is not currently robust to this type of
noise. Poor camera quality and video compression can also cause
changes in the background appearance. Compression artifacts that are
unnoticeable to the human eye can have huge effects on background
subtraction. At this point, we advocate recording video in
uncompressed format, then simultaneously compressing and tracking
using the <a class="reference" 
href="#static-background-fly-movie-format">Static Background Fly Movie 
Format</a> (sbfmf), which in our
setup achieves 100x compression without affecting tracking performance
(see below). Ctrax also performs better if the flies are significantly
different looking from the background, thus large amounts of light are
preferable, particularly at higher shutter speeds. As we record in
near-IR, flooding the arena with IR light does not affect the flies'
behavior. We have experimented with front-lit flies on a black
background (thus the flies appear as white specks on a black surround)
and back-lit flies on a white background (thus the flies appear as
black specks on a white background). See the example movies.</p>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id14" 
id="constant-velocity-considerations" 
name="constant-velocity-considerations">Constant Velocity Considerations</a></h5>
<p>To keep track of identities, Ctrax relies on the flies moving with an
approximately constant velocity. Given the previous two positions of
the flies, it predicts the positions of the flies in the current
frame. It then finds the matching of predicted positions to observed
positions that best obeys the constant velocity assumption. In
general, we've found that this assumption is obeyed by walking flies
at 20 fps (we have not tried slower frame rates). Problems with the
assumption only occur when two flies jump in close proximity of each
other.</p>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id15" 
id="splitting-and-merging-connected-components" 
name="splitting-and-merging-connected-components">Splitting and Merging 
Connected Components</a></h5>
<p>Usually, each connected component of foreground pixels corresponds to
exactly one fly. If two flies are touching, they will be detected as a
single connected component. More rarely, two connected components
of foreground pixels might be part of the same fly. Ctrax uses the
expected image area of a fly to decide whether to merge or split
connected components, and how many flies to split a large component
into. Mistakes are not uncommon when choosing the number of flies to 
split a
component into, as well as when choosing which pixels of a component
belong to which fly. There is an added step of logic called the
Hindsight step which tries to avoid the births and deaths of
trajectories by fixing potential errors in this part of the
algorithm. It relies on the splitting steps being correct in most of
the frames, and only occasionally incorrect. If the flies spend long
periods of time clustered in large, tight groups, then there is the
chance that too many mistakes will be made to fix in the Hindsight
step.</p>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id16" id="escaping-and-entering-flies"
 name="escaping-and-entering-flies">Escaping and Entering Flies</a></h5>
<p>The hindsight step mentioned above tries to fix errors made in other
parts of the algorithm to avoid new trajectories being born or
trajectories dying in the middle of the video. This is based on the
assumption that flies rarely enter or leave the arena. The Hindsight
logic can be disabled if flies commonly leave or enter the arena, but
performance is better in a closed world setup with the Hindsight logic
enabled.</p>
</div>
</div>
</div>
<div class="section">
<h3><a class="toc-backref" href="#id17" id="ctrax-installation" 
name="ctrax-installation">Ctrax Installation</a></h3>
<p>Ctrax is written in Python, and thus can be installed on all 
platforms. It has to date only been tested on 32-bit Windows and 32- and
 64-bit Linux systems. For 32-bit Windows, we have developed an 
easy-to-use Windows Installer. Follow the instructions at <a 
class="reference" href="#ctrax-installation-windows-installer">Ctrax 
Installation: Windows Installer</a>. For 32- and 64-bit Ubuntu systems, 
we have developed Debian packages. Follow the instructions at <a 
class="reference" href="#ctrax-installation-ubuntu-package">Ctrax 
Installation: Ubuntu Package</a>. For other systems, Ctrax must be 
installed from source. Follow the instructions at <a class="reference" 
href="#ctrax-installation-distutils">Ctrax Installation: DistUtils</a>.</p>
<div class="section">
<h4><a class="toc-backref" href="#id18" 
id="ctrax-installation-windows-installer" 
name="ctrax-installation-windows-installer">Ctrax Installation: Windows 
Installer</a></h4>
<p>For 32-bit Windows systems, we have developed a Windows Installer, 
available at <a class="reference" 
href="http://prdownload.berlios.de/ctrax/Ctrax-0.1.5.6-installer.exe">Ctrax
 Win32 Installer Latest Release</a>. This is the best option if you do 
not want to worry about separately installing Python and all the Python 
packages Ctrax builds upon. Download the file with the name <tt>Ctrax-&lt;version&gt;.exe</tt>,
 where <tt>&lt;version&gt;</tt> is the most recent release of Ctrax. 
Then, run the installer. This will install Ctrax to your Desktop and 
start menu. Ctrax can then be launched by double-clicking the Ctrax icon
 on the Desktop, or selecting Ctrax from the Start Menu.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id19" 
id="ctrax-installation-ubuntu-package" 
name="ctrax-installation-ubuntu-package">Ctrax Installation: Ubuntu 
Package</a></h4>
<p>For 32- and 64-bit Ubuntu systems, we have developed Debian packages 
containing pre-compiled versions of Ctrax. These are distributed at <a 
class="reference" href="http://debs.astraw.com/">Andrew Straw's Apt 
Repository</a>.</p>
<p>To install, first add <tt>http://debs.astraw.com</tt> to your list of
 repositories. Instructions are available at <a class="reference" 
href="http://debs.astraw.com/">Andrew Straw's Apt Repository</a>, and 
general directions for adding repositories in Ubuntu are available at <a
 class="reference" 
href="http://help.ubuntu.com/community/Repositories/Ubuntu#Adding%20Repositories%20in%20Ubuntu">Adding
 Repositories in Ubuntu</a>. Next, install the package <strong>python-ctrax</strong>.
 General directions for how to install software in Ubuntu are available 
at <a class="reference" 
href="http://help.ubuntu.com/community/InstallingSoftware#Installing%20a%20Package">Installing
 Software in Ubuntu</a>.</p>
<p>Ctrax can then be run from the command-line with the command <tt>Ctrax</tt>.
 It will also be added to the "Applications-&gt;Sound &amp; Video" menu.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id20" 
id="ctrax-installation-distutils" name="ctrax-installation-distutils">Ctrax
 Installation: DistUtils</a></h4>
<p>Ctrax can be installed directly from source. This requires installing
 all the <a class="reference" href="#ctrax-python-dependencies">Ctrax 
Python Dependencies</a> and a C++ compiler. The source code for Ctrax 
can be downloaded from <a class="reference" 
href="http://prdownload.berlios.de/ctrax/Ctrax-0.1.5.6.zip">Ctrax Source
 Latest Release</a>. Uncompress the archive, change into the downloaded 
"Ctrax" directory. Run the command</p>
<pre>python setup.py build</pre>
<p>to compile the code and</p>
<pre>python setup.py install</pre>
<p>to install Ctrax. Ctrax can then be run from the command-line with 
the command</p>
<pre>Ctrax</pre>
<div class="section">
<h5><a class="toc-backref" href="#id21" id="ctrax-python-dependencies" 
name="ctrax-python-dependencies">Ctrax Python Dependencies</a></h5>
<p>Ctrax depends on the following Python packages:</p>
<ul>
<li><a class="reference" href="http://www.wxpython.org/">wxPython</a> 
version &gt;= 2.8</li>
<li><a class="reference" href="http://numpy.scipy.org/">Numpy</a> 
version &gt;= 1.3.0</li>
<li><a class="reference" href="http://www.scipy.org/">Scipy</a> version 
&gt;= 0.7.1</li>
<li><a class="reference" href="http://www.pythonware.com/products/pil/">PIL</a>
 version &gt;= 1.1.6</li>
<li><a class="reference" href="http://code.astraw.com/projects/motmot/">motmot</a>.wxvideo
 version &gt;= 0.5.5</li>
<li><a class="reference" href="http://code.astraw.com/projects/motmot/">motmot</a>.wxglvideo
 version &gt;= 0.6.6</li>
<li><a class="reference" href="http://code.astraw.com/projects/motmot/">motmot</a>.wxvalidatedtext
 version &gt;= 0.5.3</li>
<li><a class="reference" href="http://code.astraw.com/projects/motmot/">motmot</a>.imops
 version &gt;= 0.5.6</li>
<li><a class="reference" href="http://code.astraw.com/projects/motmot/">motmot</a>.ufmf
 version &gt;= 0.3.2</li>
<li><a class="reference" 
href="http://code.astraw.com/projects/motmot/pygarrayimage.html">pygarrayimage</a>
 version &gt;= 0.0.7</li>
<li><a class="reference" href="http://www.pyglet.org/">pyglet</a> 
version &gt;= 1.1.4</li>
<li><a class="reference" href="http://www.pyglet.org/">pyglet</a>.avbin 
&gt;= 5</li>
<li><a class="reference" href="http://www.cython.org/">cython</a> &gt;= 
0.12.1</li>
</ul>
</div>
</div>
</div>
<div class="section">
<h3><a class="toc-backref" href="#id22" id="ctrax-usage" 
name="ctrax-usage">Ctrax Usage</a></h3>
<p>When Ctrax is started, it prompts the user for the name of the video 
to be processed. See <a class="reference" 
href="#ctrax-input-video-formats">Ctrax Input Video Formats</a> for 
information on the types of video Ctrax currently supports. Next, it 
will prompt the user for the name of the annotation file to save the 
tracking results to. This file should have the extension <tt>.ann</tt>. 
The annotation file will contain the flies' trajectories, as well as all
 parameters used during tracking. If an existing annotation file is 
selected, Ctrax can read in the parameters and trajectories, and 
tracking can be restarted.</p>
<div class="figure" style="width: 310px;" align="center">
<a class="reference image-reference" 
href="ctrax_files/ctrax_011.png"><img
 alt="Screenshot of main Ctrax window and zoom window" 
src="ctrax_files/ctrax_011.png" style="width: 300px;"></a>
<p class="caption">Screenshot of main Ctrax window (right) and zoom 
window (left).</p>
</div>
<p>Ctrax will then bring up the main Ctrax window, shown above, right. 
The main panel shows a frame of the video. To track a video, perform the
 following steps:</p>
<ol>
<li>Compute the background model: <a class="reference" 
href="#ctrax-settings-background-model">Ctrax Settings-&gt;Background 
Model...</a></li>
<li>Set the background subtraction parameters:  <a class="reference" 
href="#ctrax-settings-background-subtraction">Ctrax 
Settings-&gt;Background Subtraction...</a></li>
<li>Set the tracking parameters: <a class="reference" 
href="#ctrax-settings-tracking-settings">Ctrax Settings-&gt;Tracking 
Settings...</a></li>
<li>Begin tracking: <a class="reference" 
href="#ctrax-track-start-tracking">Ctrax Track-&gt;Start Tracking</a>. 
Note that an annotation file will not be created until tracking is 
started.</li>
<li>When tracking is complete, resolve the 180 degree orientation 
ambiguity: <a class="reference" href="#ctrax-track-choose-orientations">Ctrax
 Track-&gt;Choose Orientations...</a>.</li>
<li>Write the output trajectories to a mat file for use with the <a 
class="reference" href="#fixerrors-matlab-gui">FixErrors Matlab GUI</a>,
 the <a class="reference" href="#behavioralmicroarray-matlab-toolbox">BehavioralMicroarray
 Matlab Toolbox</a>, and other <a class="reference" 
href="http://www.mathworks.com/">Matlab</a> code: <a class="reference" 
href="#ctrax-file-export-as-mat-file">Ctrax File-&gt;Export as 
MAT-file...</a>.</li>
</ol>
<div class="section">
<h4><a class="toc-backref" href="#id23" 
id="ctrax-settings-background-model" 
name="ctrax-settings-background-model">Ctrax Settings-&gt;Background 
Model...</a></h4>
<div class="figure" style="width: 160px;" align="center">
<a class="reference image-reference" 
href="ctrax_files/ctrax_003.png"><img
 alt="Screenshot of Background Model Settings dialog" 
src="ctrax_files/ctrax_003.png" style="width: 150px;"></a>
<p class="caption">Screenshot of the Background Model Settings dialog.</p>
</div>
<p>The first step to start tracking is to set up the background model 
(see <a class="reference" href="#background-subtraction-considerations">Background
 Subtraction Considerations</a>). One first defines the parameters of 
the background model computation, then hits the "Calculate Now" button 
to compute. Note that this dialog has no effect if the movie loaded in 
is an SBFMF, as the background model is provided by that movie. The 
parameters to set are the following:</p>
<ul>
<li><em>Algorithm</em>: This is the algorithm used to estimate the 
background image and background deviation. "Median/Median Absolute 
Difference" estimates the center image as the median of the sampled 
frames and the standard deviation from the median absolute difference 
from this median. "Mean/Standard Deviation" estimates the center image 
as the mean of the sampled frames and the deviation as the standard 
deviation of the sampled frames. In all our experiments, we use the 
"Median/Median Absolute Difference" algorithm.</li>
<li><em>Number of frames</em>: Background is estimated from frames 
sampled evenly between the first frame and the last frame of the input 
video. Specify the number of frames to sample here. In all our 
experiments, we used 200 frames.</li>
<li><em>First Frame</em> and <em>Last Frame</em>: Specify the interval 
from which to sample frames to estimate the background. In our 
experiments, we noticed that the flies toward the end of longer trials 
tended to sit still, which can interfere with background modeling. In 
our current experiments, we use the first 6000 frames = 5 minutes of 
video to estimate the background model.</li>
</ul>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id24" 
id="ctrax-settings-background-subtraction" 
name="ctrax-settings-background-subtraction">Ctrax 
Settings-&gt;Background Subtraction...</a></h4>
<a class="reference image-reference" 
href="ctrax_files/ctrax_026.png"><div
 class="align-center" align="center"><img alt="Screenshot of Background 
Subtraction Settings dialog" class="align-center" 
src="ctrax_files/ctrax_026.png" style="width: 400px;"></div>
</a>
<p><em>Screenshot of the Background Subtraction Settings dialog</em></p>
<p>Background subtraction involves thresholding the difference between 
the current frame and the mean background image divided by the 
normalization image. If "Background Type" is "Light flies on a dark 
background", then we only look for pixels that are brighter than the 
background image, so we threshold</p>
<blockquote>
[distance image] = ( [current image] - [mean background image] ) / 
[normalization image]</blockquote>
<p>If "Background Type" is "Dark flies on a light background", then we 
only look for pixels that are darker than the background image, so we 
threshold</p>
<blockquote>
[distance image] = - ( [current image] - [mean background image] ) / 
[normalization image]</blockquote>
<p>If "Background Type" is "Other", then we look for any difference from
 the background, and threshold the absolute difference:</p>
<blockquote>
[distance image] = | [current image] - [mean background image] | / 
[normalization image]</blockquote>
<p>The image that is thresholded, the "distance image" can be thought of
 as the distance between the background model and the current image. 
This distance image can be seen if "Distance from Background" is 
selected from the display drop-down menu.</p>
<ul>
<li>The mean background image can be seen by selecting "Background 
Image" from the display drop-down menu. It is the mean image computed 
during the background modeling step (<a class="reference" 
href="#ctrax-settings-background-model">Ctrax Settings-&gt;Background 
Model...</a>).</li>
<li>The normalization image is defined by the "Normalize by" drop-down 
menu. It can be seen by selecting "Normalization Image" from the display
 drop-down menu.</li>
</ul>
<blockquote>
<ul>
<li>If "Standard Deviation" is selected, then we normalize by the 
thresholded standard deviation, as computed in the background modeling 
step. The thresholds are set at "Std Range". The standard deviation 
image is more susceptible to errors in estimation from flies sitting 
still for long periods of time. If you see bright spots in the 
normalization image that are fly-shaped, these are probably caused by 
flies that sit still for too long. Having bright spots like this can 
cause the background subtraction to fail in these areas, as it is 
equivalent to setting the threshold to much higher values in these 
regions of the image. One can avoid this by setting the range of allowed
 standard deviations. In our experiments, we normalize by the standard 
deviation, and we set the Standard Deviation Range so that the maximum 
standard deviation is three times the minimum standard deviation, and 
the range is centered on the average standard deviation for the arena 
(for our open arena, this is [1,3]).</li>
<li>If "Background Brightness" is selected, then we normalize by the 
background mean image. This is sometimes a reasonable approximation, as 
in general the brighter the pixel, the higher the noise is.</li>
<li>If "Homomorphic Filtering" is selected, then we approximate <a 
class="reference" 
href="http://homepages.inf.ed.ac.uk/rbf/CVonline/LOCAL_COPIES/OWENS/LECT5/node4.html#SECTION00042000000000000000">Homomorphic
 Filtering</a> on the current image. This approximation consists of 
finding the normalization image that would give the same results as 
homomorphic filtering on the background mean image, then just 
normalizing any given frame by this normalization image. The parameters 
of the homomorphic filter can be set by clicking the "Homomorphic Filter
 Settings..." button.</li>
</ul>
</blockquote>
<a class="reference image-reference" 
href="ctrax_files/ctrax_018.png"><div
 class="align-center" align="center"><img alt="Screenshot of Background 
Subtraction Settings image panel illustrations" class="align-center" 
src="ctrax_files/ctrax_018.png" style="width: 600px;"></div>
</a>
<ul>
<li><p>There may be regions of the video where there will never be 
flies. The regions of the image that will always be classified as 
background are shown in white if "Background-Only Areas" is selected 
from the display drop-down menu. One can force the algorithm to never 
detect foreground in certain regions in the following three ways.</p>
<ul>
<li>First, one can set the "Minimum Non-Foreground Intensity". All 
locations in the image such that the mean background image is above this
 value will always be classified as background. Similarly, one can set 
the "Maximum Non-Foreground Intensity" and all lcoations in the image 
such that the mean background image is below this value will always be 
classified as background.</li>
<li>Second, one can set a circular region of interest using the "Detect 
Circular Arena" dialog. All regions outside of the circle are assumed to
 be background. In this dialog, the image panel shows edges detected in 
the image. The circular region of interest can be manually adjusted by 
dragging the green and yellow circles to set the center and radius, 
respectively. Or, the "Radius", "X", and "Y" values can be adjusted 
manually. The circular region of interest can also be detected 
automatically by fitting a circle to edges in the image using the 
"Detect Arena" button. The "Refine Estimate" can be used to 
automatically refine the estimate. The edge threshold used can be 
increased or decreased using the "Edge Threshold" control. We used the 
automatically detected circular region of interest in our experiments, 
as the wall of the arena was reflective, and flies were spuriously 
detected on the walls when this region of interest was not set.</li>
<li>Third, one can set polygonal regions of interest using the "Regions 
of Interest" dialog [new in version 0.1.4]. Regions outside of all 
polygons set are assumed to be background. In this dialog, the image 
panel can show either the background model center or the currently 
selected regions of interest in white and the always-background regions 
in black. The previously selected polygons are shown by red lines. To 
select a region, click on the image. Continue clicking to add more 
points. Either double-click the start point or push the "Close" button 
to close and add the selected region. To cancel adding the current 
polygon, push the "Cancel" button. To remove the last-added polygon, use
 the "Undo" button. To save the currently selected regions, use the 
"Save" button. To close the dialog, use the "Quit" button.</li>
</ul>
</li>
</ul>
<div class="figure" style="width: 160px;" align="center">
<a class="reference image-reference" 
href="ctrax_files/ctrax_014.png"><img
 alt="Screenshot of Detect Circular Arena dialog" 
src="ctrax_files/ctrax_014.png" style="width: 150px;"></a>
<p class="caption">Screenshot of Detect Circular Arena dialog</p>
</div>
<div class="figure" style="width: 160px;" align="center">
<a class="reference image-reference" 
href="ctrax_files/ctrax_015.png"><img
 alt="Screenshot of Regions of Interest dialog" 
src="ctrax_files/ctrax_015.png" style="width: 150px;"></a>
<p class="caption">Screenshot of Regions of Interest dialog</p>
</div>
<div class="figure" style="width: 160px;" align="center">
<a class="reference image-reference" 
href="ctrax_files/ctrax_013.png"><img
 alt="Screenshot of Fix Background Model dialog" 
src="ctrax_files/ctrax_013.png" style="width: 150px;"></a>
<p class="caption">Screenshot of Fix Background Model dialog</p>
</div>
<p>To obtain a classification of each pixel location as foreground or 
background, we threshold the distance image, the normalized difference 
between the current image and the background mean. We use a hysteresis 
approach to thresholding. For a pixel to be foreground, its distance 
from the background must be above a low threshold ("Low Thresh"), and 
there must be a path from it to a pixel that is above a higher threshold
 ("High Thresh") that only goes through pixels above the low threshold. 
That is, we find all pixels that are above the low threshold, then 
remove all connected components of pixels such that no pixel in the 
connected component is above the high threshold. The low and high 
thresholds can be set with the scrollbars on the left. The low threshold
 cannot be higher than the high threshold. Changing the normalization 
algorithm will greatly change the range of distances, so the GUI tries 
to compensate for these changes in magnitude. The classification of 
pixels into foreground and background can be seen by selecting 
"Foreground/Background Classification" from the display drop-down menu.</p>
<p>If there are flies that are not being detected, lowering the high 
threshold can help. If there are objects other than flies being 
detected, raising the high threshold can help. Lowering the low 
threshold will result in the area of the detected flies being bigger and
 raising the low threshold will result in the area of the detected flies
 being smaller. Setting the low threshold too low will result in noise 
near a fly being detected as part of the fly. The benefits of a larger 
area are that we can better estimate the center position and orientation
 of the fly. The disadvantages of a larger area are that when flies are 
close to each other, they will merge into a single connected component, 
and clustering will need to be used to separate the flies, causing the 
tracker to run slower. The connected components of foreground pixels can
 be seen by selecting "Connected Components" from the display drop-down 
menu. The ellipses fit to each connected component of foreground pixels 
can be seen by selecting "Ellipse Fits" from the display drop-down menu.
 Note that if two flies are part of the same connected component, they 
will only be fit at this step by one ellipse. When tracking is 
performed, this ellipse may be split into multiple flies, depending on 
the tracking settings. This is the best display setting for looking for 
errors in the background subtraction step, as it displays the raw frame 
below the annotated ellipses. For all display settings, the frame shown 
can be controlled with the slider bar below the image panel.</p>
<p>Camera noise and compression artifacts can potentially be compensated
 for by applying morphological filtering. One can apply <a 
class="reference" 
href="http://en.wikipedia.org/wiki/Opening_%28morphology%29">Morphological
 Opening</a> and <a class="reference" 
href="http://en.wikipedia.org/wiki/Closing_%28morphology%29">Morphological
 Closing</a>. We do not use morphological filtering in our experiments.</p>
<p>If a fly sits still for too large a fraction of the video, the 
background model may assume that this fly is part of the background. 
Errors in the background modeling can be fixed using the "Fix Background
 Model" dialog [new in version 0.1.4]. Using this dialog, one can select
 polygonal regions of the image, and fill these regions by interpolating
 from the boundaries. The interface is similar to the "Regions of 
Interest" dialog. The image panel can show either the background model 
center or deviation estimates.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id25" 
id="ctrax-settings-tracking-settings" 
name="ctrax-settings-tracking-settings">Ctrax Settings-&gt;Tracking 
Settings...</a></h4>
<div class="figure" style="width: 410px;" align="center">
<a class="reference image-reference" 
href="ctrax_files/ctrax_009.png"><img
 alt="Screenshot of some of the shape parameter-related displays in the 
Tracking Settings dialog" src="ctrax_files/ctrax_009.png" style="width: 
400px;"></a>
<p class="caption">Screenshot of the Tracking Settings dialog.</p>
</div>
<p>The "Settings-&gt;Tracking Settings..." dialog controls the 
parameters of the observation detection, identity assignment, and 
hindsight steps. Please see the related sections in the online methods 
and supplementary note of <a class="reference" 
href="http://www.nature.com/nmeth/journal/vaop/ncurrent/abs/nmeth.1328.html">High-Throughput
 Ethomics in Large Groups of Drosophila</a>.</p>
<div class="figure" style="width: 410px;" align="center">
<a class="reference image-reference" 
href="ctrax_files/ctrax_027.png"><img
 alt="Screenshot of some of the shape parameter-related displays in the 
Tracking Settings dialog" src="ctrax_files/ctrax_027.png" style="width: 
400px;"></a>
<p class="caption">Screenshot of some of the shape parameter-related 
displays in the Tracking Settings dialog.</p>
</div>
<div class="figure" style="width: 210px;" align="center">
<a class="reference image-reference" 
href="ctrax_files/ctrax_024.png"><img
 alt="Screenshot of some of the motion parameter-related displays in the
 Tracking Settings dialog" src="ctrax_files/ctrax_024.png" style="width:
 200px;"></a>
<p class="caption">Screenshot of some of the motion parameter-related 
displays in the Tracking Settings dialog.</p>
</div>
<p>The right side of the dialog shows the current frame annotated with 
estimates of the positions of the flies at different stages in the 
algorithm so that the user may attempt to see the effects of many of the
 parameters. The toolbar above the image allows one to zoom in, zoom 
out, and get information about the shape of the next-selected fly. The 
following displays are available.</p>
<ul>
<li><em>Unfiltered Observations</em>: The current frame is annotated 
with the ellipses fit to each connected component of foreground pixels 
(the same as "Ellipse fits" in the background subtraction dialog).</li>
<li><em>Filtered Observations</em>: The current frame is annotated with 
the final results from the observation detection step -- the result of 
modifying the ellipse fits based on the model of allowed fly shapes.</li>
<li><em>Small Observations</em>: The current frame is annotated with 
ellipse fits for only those connected components whose area is smaller 
than the minimum area.</li>
<li><em>Large Observations</em>: The current frame is annotated with 
ellipse fits for the only those connected components whose area is 
bigger than the maximum area.</li>
<li><em>Deleted Observations</em>:The current frame is annotated with 
the initial ellipse fits for connected components that are ignored in 
the detection step.</li>
<li><em>Split Observations</em>: The current frame is annotated with 
observation detections that resulted from large observations being split
 into multiple flies.</li>
<li><em>Merged Observations</em>: The current frame is annotated with 
observation detections that resulted from small observations being 
merged into a single fly.</li>
<li><em>Threshold-Lowered Observations</em>: The current frame is 
annotated then observation detections whose initial area was small and 
were enlarged by lowering the background subtraction threshold nearby.</li>
<li><em>Max Jump</em>: Illustration of the "Max Jump Distance" parameter
 from the "Motion" tab. The current frame is annotated with a circle for
 each fly. The radius of this circle reflects the maximum distance 
between the predicted and detected positions of a fly if the change in 
orientation is zero. If the distance is larger than this, then the 
algorithm will instead create a new trajectory.</li>
<li><em>Motion Model Prediction</em>: Illustration of the motion model 
parameters. For each fly in the current frame, we show the previous two 
positions of the fly and the predicted position of the fly in this 
frame. The green bars and blue arcs illustrate the relative weight of 
errors in orientation matching and center position matching. The green 
lines are equivalent in error weight to the blue arcs.</li>
</ul>
<p>There are four tabs in the Tracking Settings dialog, described below.</p>
<a class="reference image-reference" 
href="ctrax_files/ctrax_031.png"><div
 class="align-center" align="center"><img alt="Screenshot of the four 
Trackings Settings tabs" class="align-center" 
src="ctrax_files/ctrax_031.png" style="width: 400px;"></div>
</a>
<p><em>Screenshot of the four Tracking Settings dialog tabs.</em></p>
<div class="section">
<h5><a class="toc-backref" href="#id26" 
id="ctrax-tracking-settings-shape-parameters" 
name="ctrax-tracking-settings-shape-parameters">Ctrax Tracking Settings 
Shape Parameters</a></h5>
<p>The parameters controlled by the Tracking Settings Shape tab describe
 the expected sizes of the ellipses fit to each fly. These parameters 
set the minimum allowed, expected, and maximum allowed <em>area</em> of a
 fit ellipse, <em>major axis length</em> of a fly, <em>minor axis length</em>
 of a fly*, and <em>eccentricity</em> of a fly. Currently, only the 
area, major axis length, and minor axis length bounds are used by the 
tracking algorithm.</p>
<p>If the area of a connected component is larger than the maximum area,
 the algorithm clusters the pixel locations in the component into 
iteratively increasing numbers of ellipse fits (the shape-parameter 
related displays above show a large connected component that is split 
into two ellipses). The number of ellipses to split into is chosen so 
that each ellipse respects the area and major and minor axis length 
upper bounds, and the area of each ellipse is close to the mean area.</p>
<p>If the area of a connected component is smaller than the minimum area
 allowed, then we try to enlarge it first by decreasing the background 
subtraction threshold near the connected component. If this does not 
result in a sufficiently large connected component, then we try to merge
 it with nearby connected components without changing the 
foreground/background classification of too many pixels. The minimum 
area should thus be set to first make the expected area of a fly close 
to the mean of the minimum and maximum bounds on the area and second so 
that it is approximately the minimum area of a fly. (In the next version
 of Ctrax, we plan to separate the mean area and minimum and maximum 
area controls.)</p>
<p>One can use the "Automatically Compute Bounds on Shape" option to 
estimate these bounds. This will cause the algorithm to sample "Number 
of Frames" frames from the video, then find the median and median-based 
approximation of the standard deviation of the area, major and minor 
axis lengths, and eccentricity of the connected components of foreground
 pixels in these frames. One can then approximate the bounds as the 
median plus or minus some number of standard deviations. The results of 
the automatic computation are shown in the "Manually Set Bounds on 
Shape" section, and can be adjusted manually after being approximated 
automatically.</p>
<p>When we are choosing the parameters for a new experimental set-up, we
 first automatically compute the bounds from 50 frames and set the 
"Number of standard deviations" to 3. Then, we use the "?" toolbar 
button to inspect the actual sizes of the ellipses in some frames with 
the "Unfiltered Observations" display selected, and set the maximum 
bounds to be the maximum value we observe in our sample. Finally, we set
 the minimum bound on area so that the mean of the minimum and maximum 
bounds on area is near the automatically-set mean of the minimum and 
maximum bounds. We then scroll through a bunch of frames with the "Small
 Observations" and "Large Observations" displays selected, to and make 
sure that there are not many small observations and that the large 
observations in general correspond to connected components consisting of
 multiple flies. One can also use the "Filtered", "Merged", "Split", and
 "Threshold-Lowered" displays to observe the effects of these 
parameters.</p>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id27" 
id="ctrax-tracking-settings-motion-parameters" 
name="ctrax-tracking-settings-motion-parameters">Ctrax Tracking Settings
 Motion Parameters</a></h5>
<p>We assign identities to each detected observation by matching the 
detected ellipse fits to the predicted ellipse positions based on the 
tracking results in the previous two frames and the motion model. We 
want to minimize the distance between the detected and predicted 
ellipses. This distance is based on both the center position of the 
ellipse and its orientation. The "Angle Weight" parameter specifies the 
relative importance of the orientation with respect to the center 
position. The total error is the squared distance between the predicted 
and detected center positions plus the angle weight times the squared 
distance between the predicted and detected orientations (known only 
modulo pi radians). The error in the center position is measured in 
squared pixels and the error in the orientation is measured in squared 
radians. Thus, the angle weight should be higher than 1, even if the 
desired effect is that the orientation be less important than the center
 position in the matching. In all our experiments, we used weight 100. 
The relative importance of the center position versus the orientation 
can be visualized using the "Motion Model Prediction" display. An error 
in the center position prediction equal to the length of a green bar is 
equivalent to an error in the orientation of size equal to the blue arc.</p>
<p>The "Max Jump Distance" is the square root of the maximum error 
allowed between predicted and observed positions. If the orientation 
error is 0, then this is the maximum distance that a fly is allowed to 
jump from its predicted position. The "Max Jump" display allows one to 
visualize this distance, as the circles drawn around each fly are of 
radius "Max Jump Distance".</p>
<p>The "Center Dampening" and "Angle Dampening" control the predicted 
position of the fly given its previous two positions. We predict that 
the center position will be the previous center position plus the 
velocity times one minus the "Center Dampening" coefficient, and that 
the orientation will be the previous orientation plus the angular 
velocity times one minus the "Angle Dampening" coefficient. In our 
experiments, we set the center dampening coefficient to 0 (pure constant
 velocity model), and the angle dampening coefficient to 0.5. The 
effects of these parameters can be seen in the "Motion Model Prediction"
 display, which shows the predicted positions of the flies based on this
 dampened constant velocity model.</p>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id28" 
id="ctrax-tracking-settings-observation-parameters" 
name="ctrax-tracking-settings-observation-parameters">Ctrax Tracking 
Settings Observation Parameters</a></h5>
<p>The observation parameters affect the processing of connected 
components of foreground pixels into ellipse fits.</p>
<ul>
<li><em>Max Area Delete</em>: If a connected component cannot be merged 
with other connected components or sufficiently enlarged by lowering the
 background subtraction threshold and has area at most "Max Area 
Delete", then this connected component is ignored and not included as an
 observation detection. Area is measured in pixels-squared.</li>
<li><em>Min Area Ignore</em>: Extremely large connected components may 
be caused by objects other than flies or lighting changes. "Min Area 
Ignore" is the minimum area of large foreground detections to be 
ignored.</li>
<li><em>Max Penalty Merge</em>: We check to see if small connected 
components can be merged with nearby connected components by flipping 
the labels of some pixels from background to foreground. "Max Penalty 
Merge" is the maximum total distance from the background model minus the
 foreground threshold of the background pixels that must be flipped to 
connect the two connected components.</li>
<li><em>Lower Threshold</em>: If the area of a connected component is 
small, we will try to lower the foreground/background threshold around 
this connected component to increase its area. We lower the threshold to
 "Lower Threshold" times the current lower threshold.</li>
</ul>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id29" 
id="ctrax-tracking-settings-hindsight-parameters" 
name="ctrax-tracking-settings-hindsight-parameters">Ctrax Tracking 
Settings Hindsight Parameters</a></h5>
<p>Because our algorithm performs detection independently of matching, 
errors in the observation detection step are common. We use the <em>hindsight</em>
 step to modify trajectories after matching to avoid the deaths and 
births of trajectories. There are four types of modifications we can 
make. The checkboxes in the "Hindsight" tabs indicate whether we will 
attempt each of the four types. For each of the four types, "Max 
Sequence Length" indicates the number of frames we will look backward to
 fix these potential errors. In all our experiments, we set this to 50 
for all types of errors.</p>
<ul>
<li><em>Fix Split Detections</em>: We look for births of trajectories 
caused by a single fly being split into two detections. These two 
detections will be merged for up to "Max Sequence Length" frames to 
avoid the trajectory birth if the merge penalty (number of pixels that 
must be flipped from background to foreground to merge) is less than 
"Max Penalty Merge". We set this to 40, the same value we used for "Max 
Penalty Merge" in the "Observation" tab.</li>
<li><em>Fix Merged Detections</em>: We look for deaths of trajectories 
caused by two flies being merged into a single detection. These 
detections will be split for up to "Max Sequence Length" frames to avoid
 the trajectory death if the change in the total prediction error in the
 first frame merged is at most "Max Prediction Error Increase". Recall 
that the units of this can be thought of as pixels-squared. We used 20 
in all our experiments.</li>
<li><em>Fix Spurious Detections</em>: We will delete any newly born 
trajectories that die within "Max Sequence Length" frames.</li>
<li><em>Fix Lost Detections</em>: Given a trajectory birth, we look 
backward up to "Max Sequence Length" frames to see if there is a 
trajectory death that would end up near this trajectory birth, then 
connect the trajectories to avoid the track birth.</li>
</ul>
</div>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id30" id="ctrax-track-start-tracking" 
name="ctrax-track-start-tracking">Ctrax Track-&gt;Start Tracking</a></h4>
<p>The "Track" menu has various ways to start/restart tracking.</p>
<ul>
<li><em>Start Tracking</em> will delete any trajectories computed 
previously, and start tracking from the current frame. Be careful with 
this option.</li>
<li><em>Resume Tracking</em> will go to the last frame for which 
trajectories have been computed, and restart tracking from there.</li>
<li><em>Resume Tracking from Current Frame</em> will keep trajectories 
computed for frames before the current frame, remove trajectories from 
this frame on, and restart tracking from the current frame.</li>
</ul>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id31" 
id="ctrax-track-choose-orientations" 
name="ctrax-track-choose-orientations">Ctrax Track-&gt;Choose 
Orientations...</a></h4>
<div class="figure" align="center">
<a class="reference image-reference" 
href="ctrax_files/ctrax_028.png"><img
 alt="Screenshot of Choose Orientations dialog" 
src="ctrax_files/ctrax_028.png" style="width: 200px;"></a>
<p class="caption">Screenshot of "Choose Orientations..." dialog.</p>
</div>
<p>The tracking algorithm only computes orientation modulo pi radians --
 it does not resolve the head-tail ambiguity. "Choose Orientations..." 
resolves this ambiguity using the velocity of the flies. It is based on 
the following two assumptions:</p>
<ol>
<li>When the fly is walking, it is usually walking forward.</li>
<li>The orientation does not change much from one frame to the next.</li>
</ol>
<p>"Choose Orientations..." decides whether to add pi radians to a fly's
 orientation in each frame to minimize the following criterion:</p>
<a class="reference image-reference" 
href="ctrax_files/ctrax.jpg"><div
 class="align-center" align="center"><img alt="chooseorientations 
criterion" class="align-center" src="ctrax_files/ctrax.jpg" 
style="width: 350px;"></div>
</a>
<p>Here, J<sup>1</sup> is the velocity direction constraint, where θ<sub>t</sub>
 is the orientation at frame t modulo π radians, φ<sub>t</sub> is the 
velocity direction at frame t modulo 2|pi| radians, and s<sub>t</sub> is
 whether or not to add π to the orientation. J<sup>2</sup> is the 
temporal constraint. v<sub>t</sub> is the speed in frame t. The weight 
w(v<sub>t</sub>) is the weight of the velocity term with respect to the 
temporal term:</p>
<a class="reference image-reference" 
href="ctrax_files/ctrax_004.jpg"><div
 class="align-center" align="center"><img alt="chooseorientations 
criterion" class="align-center" src="ctrax_files/ctrax_004.jpg" 
style="width: 175px;"></div>
</a>
<p>λ is the "Velocity Weight Constant" and w<sub>max</sub> is the 
"Maximum Velocity Weight". In all our experiments, we set "Velocity 
Weight Constant" to .05 and "Maximum Velocity Weight" to 0.25.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id32" 
id="ctrax-file-export-as-mat-file" name="ctrax-file-export-as-mat-file">Ctrax
 File-&gt;Export as MAT-file...</a></h4>
<p>To analyze the trajectories in Matlab using either the FixErrors GUI 
or the BehavioralMicroarray toolbox, one must save the trajectories to a
 Matlab-native format. This can be done by selecting "File-&gt;Export as
 MAT-file". This will prompt the user for the name of a mat file. It 
will save the following variables:</p>
<ul>
<li><tt>ntargets</tt>: <tt>1 x nframes</tt> vector, where <tt>ntargets(t)</tt>
 is the number of flies tracked in frame <tt>t</tt>.</li>
<li><tt>identity</tt>: <tt>1 x sum(ntargets)</tt> vector, where <tt>identity(1:ntargets(1))</tt>
 are the identities of the flies tracked in frame 1, <tt>identity(ntargets(1)+1:ntargets(1)+ntargets(2))</tt>
 are the identies of the flies tracked in the second frame, etc.</li>
<li><tt>x_pos</tt>: <tt>1 x sum(ntargets)</tt> vector, indexed as 
identity, storing the x-coordinate of the center of a fly in pixels.</li>
<li><tt>y_pos</tt>: <tt>1 x sum(ntargets)</tt> vector, indexed as 
identity, storing the y-coordinate of the center of a fly in pixels.</li>
<li><tt>maj_ax</tt>: <tt>1 x sum(ntargets)</tt> vector, indexed as 
identity, storing the quarter-major axis length of a fly in pixels.</li>
<li><tt>min_ax</tt>: <tt>1 x sum(ntargets)</tt> vector, indexed as 
identity, storing the quarter-minor axis length of a fly in pixels.</li>
<li><tt>angle</tt>: <tt>1 x sum(ntargets)</tt> vector, indexed as 
identity, storing the orientation of a fly in radians.</li>
</ul>
<p>As is, this is not the easiest-to-use format for Matlab. The <a 
class="reference" href="#load-tracks-m">load_tracks.m</a> function reads
 in this mat file and writes it out in a more usable format.</p>
<p>"File-&gt;Write Timestamps to MAT-file..." operates the same as 
"File-&gt;Export as MAT-file..." except that it also saves the <tt>1 x 
nframes</tt> array <tt>timestamps</tt> which contains the timestamp from
 each frame.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id33" id="ctrax-display-control" 
name="ctrax-display-control">Ctrax Display Control</a></h4>
<p>The frame shown can in the main panel can be controlled with the 
slider bar below it. The frame number is also shown in the toolbar at 
the bottom, and the frame shown can also be modified by editing this 
shown frame number. The buttons on the toolbar, from left to right, have
 the following effects:</p>
<ul>
<li>Magnifying glass: If this is selected, when the user clicks on a fly
 in the main panel the zoom window (above, left) will pop up and show 
the selected fly in higher resolution. As the frame displayed changes, 
these zoomed views will update.</li>
<li>Play button: This will play the video at the speed set in "Play 
Speed".</li>
<li>Stop button: This will stop playback of the video if the video is 
currently playing, or stop tracking if the video is currently being 
tracked.</li>
<li>Fast-forward button: If the video is playing, then this will 
increase the playback speed. If the video is being tracked, this will 
increase the rate with which the display is refreshed.</li>
<li>Rewind button: If the video is playing, then this will decrease the 
playback speed. If the video is being tracked, this will decrease the 
rate at with the display is refreshed. For fastest tracking, one can 
turn off automatic refreshing altogether in the Settings-&gt;Playback 
Options menu.</li>
<li>Refresh button: During tracking, clicking this button will result in
 the display refreshing after the next-tracked frame.</li>
</ul>
<p>The "Settings-&gt;Playback Options" menu allows one to set the 
following playback parameters:
* "Show Old Annotation*: Whether we annotate the displayed movie with 
the computed trajectories or not.
* "Tail Length": Number of frames for which to plot the center position 
of the fly previous to the current frame.
* "Automatically Refresh": During tracking, whether we refresh the 
screen with the current tracking results.
* "Dim Original": Whether we should show the raw video darker -- this 
causes the trajectories to stand out more in the display.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id34" id="ctrax-batch-processing" 
name="ctrax-batch-processing">Ctrax Batch Processing</a></h4>
<div class="figure" align="center">
<a class="reference image-reference" 
href="ctrax_files/ctrax_030.png"><img
 alt="Screenshot of Batch Processing dialog" 
src="ctrax_files/ctrax_030.png" style="width: 200px;"></a>
<p class="caption">Screenshot of "Batch Processing" dialog.</p>
</div>
<p>Ctrax can be set up to process multiple movies in a row.</p>
<ol>
<li>Choose the movies to be processed using the "Add" and "Remove" 
buttons.</li>
<li>"Circular Arena": Set whether you want to auto-detect the circular 
arena independently in each new movie or whether you want to use the 
arena settings from the first movie. If in the currently loaded movie, 
it is set not to use a circular region of interest, then none will be 
used in all the movies. If in the currently loaded movie, it is set to 
use a circular region of interest, that exact region of interest will be
 used in all the movies.</li>
<li>"Shape": Set whether you want to auto-detect the shape parameters (<a
 class="reference" href="#ctrax-tracking-settings-shape-parameters">Ctrax
 Tracking Settings Shape Parameters</a>) in each movie, or use the shape
 parameters set in the first movie.</li>
<li>"Background Model": Set whether you want to recompute the background
 model for each new movie, or use the background model from the current 
movie.</li>
<li>Hit "Execute" to being tracking.</li>
</ol>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id35" id="ctrax-other-commands" 
name="ctrax-other-commands">Ctrax Other Commands</a></h4>
<ul>
<li><p><strong>File Menu</strong></p>
<ul>
<li><em>Open</em>: Open a different movie file.</li>
<li><em>Load Settings from File...</em>: Load the Ctrax settings from a 
different annotation file.</li>
<li><em>Export as AVI-file</em>: Writes the movie annotated with the 
computed trajectories to an uncompressed AVI.</li>
<li><em>Quit</em>: Quit Ctrax.</li>
</ul>
</li>
<li><p><strong>Track</strong></p>
<ul>
<li><em>Write compressed sbfmf while tracking</em>: Writes an sbfmf (<a 
class="reference" href="#static-background-fly-movie-format">Static 
Background Fly Movie Format</a>) version of the movie while tracking. 
This uses the background model and background subtraction parameters 
used by the tracker to perform the compression.</li>
<li><em>Compute Background</em>: Computes the background model with the 
current background model parameters (see <a class="reference" 
href="#ctrax-settings-background-model">Ctrax Settings-&gt;Background 
Model...</a>).</li>
<li><em>Compute Target Shape</em>: Automatically estimates the shape 
parameters using the current shape parameters (see <a class="reference" 
href="#ctrax-tracking-settings-shape-parameters">Ctrax Tracking Settings
 Shape Parameters</a>).</li>
</ul>
</li>
<li><p><strong>Settings</strong></p>
<ul>
<li>"Show Zoom Window": whether to show the zoom window display.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section">
<h3><a class="toc-backref" href="#id36" 
id="example-video-annotation-and-mat-files" 
name="example-video-annotation-and-mat-files">Example Video, Annotation,
 and Mat files</a></h3>
<p>For the purposes of testing your installation of Ctrax, we provide 
some example <a class="reference" 
href="#static-background-fly-movie-format">Static Background Fly Movie 
Format</a> videos with the corresponding annotation and mat files 
created by Ctrax and FixErrors at <a class="reference" 
href="https://developer.berlios.de/project/showfiles.php?group_id=10360&amp;release_id=16219">Example
 SBFMF videos, annotation files, and mat files</a>.</p>
<p>Each of the provided zip files contains the following:</p>
<ul>
<li>movie&lt;date&gt;.sbfmf : <a class="reference" 
href="#static-background-fly-movie-format">Static Background Fly Movie 
Format</a> video. When Ctrax is started, this video can be used as the 
input.</li>
<li>movie&lt;date&gt;.sbfmf.ann: Annotation file created by Ctrax (see <a
 class="reference" href="#ctrax-usage">Ctrax Usage</a>) containing the 
tracking parameters and computed trajectories. We include the "fixed" 
results -- the results processed through the <a class="reference" 
href="#fixerrors-matlab-gui">FixErrors Matlab GUI</a>. When Ctrax 
prompts the user for the name of the annotation file to save results to,
 if this file is given, tracking parameters and results will be loaded 
from here. Alternatively, a different annotation file can be set to 
write results to, but tracking parameters can be loaded from this 
annotation file using "File-&gt;Load Settings from File" (see <a 
class="reference" href="#ctrax-other-commands">Ctrax Other Commands</a>).</li>
<li>movie&lt;date&gt;.mat: Matlab data file containing the "trx" 
variable, as described at <a class="reference" href="#load-tracks-m">load_tracks.m</a>.</li>
</ul>
<p>The movies provided are:</p>
<ul>
<li><a class="reference" 
href="http://prdownload.berlios.de/ctrax/example-sbfmfvideo-ann-mat-5M5F5min-20090518.zip">example-sbfmfvideo-ann-mat-5M5F5min-20090518.zip</a>
 (35MB): 5 minute video of 5 male and 5 female flies.</li>
<li><a class="reference" 
href="http://prdownload.berlios.de/ctrax/example-sbfmfvideo-ann-mat-25M25F5min-20090518.zip">example-sbfmfvideo-ann-mat-25M25F5min-20090518.zip</a>
 (140MB): 5 minute video of 25 male and 25 female flies.</li>
</ul>
<p>To test whether AVI reading is working with your installation of 
Ctrax, we also provide short AVI clips from the first 100 frames of the 
SBFMF video in example-sbfmfvideo-ann-mat-5M5F5min-20090518.zip. We 
provide a zipped, uncompressed video created using Matlab and compressed
 videos in a variety of codecs created using VirtualDub:</p>
<ul>
<li><a class="reference" 
href="http://prdownload.berlios.de/ctrax/movie20071009_163231_frames0001to0100.zip">movie20071009_163231_frames0001to0100.zip</a>
 (65MB): Zipped, uncompressed AVI created using Matlab.</li>
<li><a class="reference" 
href="http://prdownload.berlihttp://download.berlios.de/ctrax/movie20071009_163231_frames0001to0100_huffyuv.avi">movie20071009_163231_frames0001to0100_huffyuv.avi</a>
 (102MB): Compressed with the HuffYUV codec using VirtualDub.</li>
<li><a class="reference" 
href="http://prdownload.berlihttp://download.berlios.de/ctrax/movie20071009_163231_frames0001to0100_ffdshow.avi">movie20071009_163231_frames0001to0100_ffdshow.avi</a>
 (222KB): Compressed with the ffdshow codec using VirtualDub.</li>
<li><a class="reference" 
href="http://prdownload.berlihttp://download.berlios.de/ctrax/movie20071009_163231_frames0001to0100_xvid.avi">movie20071009_163231_frames0001to0100_xvid.avi</a>
 (212KB): Compressed with the XviD codec using VirtualDub.</li>
</ul>
</div>
</div>
<hr class="docutils">
<div class="section">
<h2><a class="toc-backref" href="#id37" id="fixerrors-matlab-gui" 
name="fixerrors-matlab-gui">FixErrors Matlab GUI</a></h2>
<p>The FixErrors Matlab GUI identifies frames in which the tracker may 
have performed poorly, shows these to a user, and allows the user to 
correct any mistakes. Suspicious frames and flies are those in which:</p>
<ul>
<li>A fly's trajectory ends.</li>
<li>A fly's trajectory begins.</li>
<li>The cost of swapping the identities of a pair of flies is small.</li>
<li>The constant velocity motion model poorly predicts the trajectories 
(i.e. the fly jumps).</li>
<li>The major axis length for a fly is large.</li>
<li>The orientation of the fly changes a lot from one frame to the next.</li>
<li>The velocity direction and the orientation do not match.</li>
</ul>
<p>These frames are shown in order of most to least suspicious. The user
 then has the option to modify the fit trajectories to correct any 
mistakes in the tracking. Empirically, we found that all identity errors
 were easily identified and fixed using this GUI.</p>
<div class="section">
<h3><a class="toc-backref" href="#id38" id="fixerrors-requirements" 
name="fixerrors-requirements">FixErrors Requirements</a></h3>
<p>The FixErrors GUI written in Matlab, and requires <a 
class="reference" href="http://www.mathworks.com/">Matlab</a> version 
&gt;= 2008a. Licenses for the <a class="reference" 
href="http://www.mathworks.com/products/image/">Matlab Image Processing 
Toolbox</a> and the <a class="reference" 
href="http://www.mathworks.com/products/statistics/">Matlab Statistics 
Toolbox</a> are also necessary.</p>
</div>
<div class="section">
<h3><a class="toc-backref" href="#id39" id="fixerrors-installation" 
name="fixerrors-installation">FixErrors Installation</a></h3>
<p><strong>Download</strong>:</p>
<ul>
<li>FixErrors and BehavioralMicroarray rely on a common library of 
Matlab helper functions. If you plan to use both the FixErrors Matlab 
GUI and the <a class="reference" 
href="#behavioralmicroarray-matlab-toolbox">BehavioralMicroarray Matlab 
Toolbox</a>, download the latest release of all the Matlab code from <a 
class="reference" 
href="http://prdownload.berlios.de/ctrax/Ctrax-allmatlab-0.1.04.zip">Ctrax
 Matlab Toolboxes Latest Release</a>.</li>
<li>The latest release of all the Matlab code necessary to run the 
FixErrors GUI (FixErrors and Matlab helper functions) can be downloaded 
from <a class="reference" 
href="http://prdownload.berlios.de/ctrax/fixerrors-0.1.04.zip">FixErrors
 Matlab GUI Latest Release</a>.</li>
<li>The latest release of all the Matlab code specific to the FixErrors 
GUI can be downloaded from <a class="reference" 
href="http://prdownload.berlios.de/ctrax/fixerrors-only-0.1.04.zip">FixErrors
 Matlab GUI Only Latest Release</a>.</li>
<li>The development version of the FixErrors and Matlab helper code can 
be checked on using <a class="reference" 
href="http://subversion.tigris.org/">Subversion</a> (see instructions at
 <a class="reference" 
href="http://developer.berlios.de/svn/?group_id=10360">Ctrax SVN 
Instructions</a>). The FixErrors code is in the directory <tt>ctrax/trunk/fixerrors</tt>
 and the Matlab helper functions are in the directory <tt>ctrax/trunk/matlab</tt>.</li>
</ul>
<p>To run the FixErrors GUI:</p>
<ol>
<li>Unzip the downloaded Matlab code. Note the location of the 
downloaded directory <tt>fixerrors</tt>.</li>
<li>Start up Matlab.</li>
<li>Change into the <tt>fixerrors</tt> directory.</li>
<li>Run the script <tt>fixerrors</tt> by typing <tt>fixerrors</tt> at 
the command-line.</li>
</ol>
</div>
<div class="section">
<h3><a class="toc-backref" href="#id40" id="fixerrors-usage" 
name="fixerrors-usage">FixErrors Usage</a></h3>
<div class="section">
<h4><a class="toc-backref" href="#id41" id="fixerrors-start-up" 
name="fixerrors-start-up">FixErrors Start-Up</a></h4>
<p>FixErrors begins by prompting the user for the name of the raw movie 
whose trajectories are to be checked, followed by the name of the mat 
file containing the trajectories to be checked, and the name of the 
corresponding Ctrax annotation file. If the trajectories have not yet 
been augmented with the pixel to millimeter and frame to second 
conversions, the <a class="reference" href="#convert-units-m">convert_units.m</a>
 script is run to get these. FixErrors then checks to see if it has 
already been run on this movie and there is saved information available 
to restart running. If it finds such saved information, it prompts the 
user to see if he wants to restart.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id42" 
id="fixerrors-suspiciousness-parameters" 
name="fixerrors-suspiciousness-parameters">FixErrors Suspiciousness 
Parameters</a></h4>
<p>If he chooses not to restart, he is then prompted for parameters for 
detecting "suspicious" trajectory sequences -- these are sequences in 
which tracking is more likely to have failed. The suspiciousness 
parameters are the following:</p>
<div class="figure" style="width: 210px;" align="center">
<a class="reference image-reference" 
href="ctrax_files/ctrax_016.png"><img
 alt="Screenshot of FixErrors Suspiciousness Parameters dialog" 
src="ctrax_files/ctrax_016.png" style="width: 200px;"></a>
<p class="caption">Screenshot of FixErrors Suspiciousness Parameters 
dialog.</p>
</div>
<ul>
<li><em>Minimum suspicious prediction - detection error (mm)</em>: This 
parameter is used to identify sequences in which the constant velocity 
motion model poorly predicts the trajectories. All sequences in which 
the error between the constant velocity prediction and the measured 
positions is greater than the set value will be flagged. By default, 
this is initialized to one-fifth the "Max Jump Error" read from the 
Ctrax annotation file.</li>
<li><em>Minimum suspicious orientation change (deg)</em>: All sequences 
in which the change in orientation is greater than the set value will be
 flagged. We use 45 degrees in our experiments.</li>
<li><em>Minimum suspiciously large major axis (mm)</em>: All sequences 
in which the major axis length is greater than the set value will be 
flagged. For reference, the max and mean major axis lengths read from 
the Ctrax annotation file are shown.</li>
<li><em>Minimum suspicious orientation - velocity direction mismatch 
(deg)</em>.</li>
<li><em>Minimum walking speed (mm/frame)</em>: All sequences in which 
the fly is walking with speed greater than this minimum walking speed <em>and</em>
 the orientation and velocity direction mismatch by the above value will
 be flagged.</li>
<li><em>Maximum ambiguous error (mm^2)</em>: All sequences in which the 
increase in error for swapping a pair of identities is less than the set
 value will be flagged.</li>
</ul>
<p>Note that it is okay to set these suspiciousness parameters to be 
overly cautious, i.e. so that a lot of sequences are flagged. The 
FixErrors GUI will show the sequences in order from most suspicious to 
least suspicious sequence of a given type. Once the user feels that the 
rest of the sequences of a given type are probably correct, he can move 
on to another type of suspicious sequence, or quit the program 
altogether.</p>
<p>Once these parameters are set, FixErrors goes through the 
trajectories and identifies the suspicious sequences. Depending on the 
number and length of the trajectories, this may take some time. When it 
is done, it initializes the mat file containing the current results of 
FixErrors that can be used to restart the GUI, then brings up the 
FixErrors GUI.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id43" id="fixerrors-gui-display" 
name="fixerrors-gui-display">FixErrors GUI Display</a></h4>
<div class="figure" style="width: 410px;" align="center">
<a class="reference image-reference" 
href="ctrax_files/ctrax_017.png"><img
 alt="Screenshot of FixErrors GUI" src="ctrax_files/ctrax_017.png" 
style="width: 400px;"></a>
<p class="caption">Screenshot of FixErrors GUI.</p>
</div>
<p>The left side of the GUI shows the current frame annotated with the 
trajectories of the fly. For each fly, we show the fit ellipse. Tail 
direction is indicated by a line segment. Using the "Plot Path" 
drop-down menu, one can select whether the paths of "All Flies", "Seq 
Flies" (only those flies that are part of the current suspicious 
sequence), or "No Flies" are plotted. The number of frames of trajectory
 around the current frame that are plotted can be adjusted with the 
"NFrames Plot" control. The "Zoom" drop-down menu controls whether we 
zoom in on the flies in the current sequence, or show the whole arena. 
The zoom level and region of the arena shown can also be set manually 
using the figure toolbar zoom and pan tools.</p>
<p>The "Sequence Info" box shows information about the current 
suspicious sequence. The "Error" number shows which error sequence of 
this type is shown (this is not indexed by suspiciousness, but rather 
fly and frame). It shows the numbers of the frames and the identities of
 the flies that are suspicious ("Frames" and "Flies"). It shows the 
"Type" of suspicious sequence, and finally the suspiciousness of the 
sequence ("Susp"). The "suspiciousness" measure varies from one type of 
error to another, but will always be nonnegative for the selected 
sequences, and zero for the least suspicious sequence selectable.</p>
<p>The "Frame Info" box shows information about the current frame and 
flies. It shows the (editable) current frame number, which frame of the 
current sequence this is, the suspiciousness for the current frame (the 
suspiciousness of the sequence is the maximum per-frame suspiciousness 
over all frames in the sequence). The "Selected Fly" shows the identity 
of the last clicked fly. This is useful if the colors of flies being 
examined are similar.</p>
<p>The "Navigation Tools" control the order in which suspicious 
sequences are shown. Here, the user can select the next type of error to
 show, and whether the sequences should be sorted by suspiciousness, 
fly, or frame. We recommend sorting by suspiciousness. When the user is 
satisfied that the trajectories are correct, he can hit the "Correct" 
button to go on to the next sequence. The "Back" button is not yet 
implemented, the "Save" button saves the current state of the GUI to the
 restart file, and the "Quit" button exits the GUI.</p>
<p>The "Seek Tools" allow one to change the current frame to the next or
 previous track birth or death in the currently selected axes.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id44" 
id="fixerrors-manipulating-trajectories" 
name="fixerrors-manipulating-trajectories">FixErrors Manipulating 
Trajectories</a></h4>
<p>The positions of the flies in the current frame can be manipulated by
 dragging around the plotted ellipses. The center position of the 
ellipse can be changed by dragging the white circle at the center of the
 ellipse. The white circles at the four end points of the fly's axes can
 be dragged independently to set these points.</p>
<p>For more drastic changes to the trajectories, one can use the "Edit 
Tools".</p>
<div class="section">
<h5><a class="toc-backref" href="#id45" 
id="fixerrors-edit-tools-delete-track" 
name="fixerrors-edit-tools-delete-track">FixErrors Edit Tools: Delete 
Track</a></h5>
<p>This tool is used to delete the trajectory of a selected fly from the
 selected frame to the end of its track. To delete the fly's entire 
trajectory, one would therefore want to delete from the first frame of 
its trajectory. Follow these steps to delete a trajectory portion:</p>
<ol>
<li>Scroll to the first frame of the portion of track to be deleted.</li>
<li>Click on the fly to be deleted.</li>
<li>Push the "Do It" button.</li>
</ol>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id46" 
id="fixerrors-edit-tools-swap-identities" 
name="fixerrors-edit-tools-swap-identities">FixErrors Edit Tools: Swap 
Identities</a></h5>
<p>This tool is used to swap the identities of a selected pair of flies 
from a selected frame to the end of their tracks. Follow these steps:</p>
<ol>
<li>Scroll to the first frame of the portion of tracks to be swapped.</li>
<li>Select the two flies to be swapped.</li>
<li>Push the "Do It" button.</li>
</ol>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id47" 
id="fixerrors-edit-tools-connect-tracks" 
name="fixerrors-edit-tools-connect-tracks">FixErrors Edit Tools: Connect
 Tracks</a></h5>
<p>If a fly is lost for some number of frames and then reborn as a new 
fly identity, one can connect the end of one trajectory to the start of 
another. Follow these steps:</p>
<ol>
<li>Scroll to the first frame of the portion of track to be connected.</li>
<li>Select the first fly to be connected.</li>
<li>Push the "First Fly" button.</li>
<li>Scroll to the last frame of the portion of track to be connected.</li>
<li>Click on the second fly to be connected to.</li>
<li>Push the "Do It" button.</li>
</ol>
<p>If neither of the flies is alive during a subset of the frames, the 
position of the fly is set by linearly interpolating between its start 
and end locations. If both flies are alive during a portion of the 
frames, the position of the fly is set as the average of these two.</p>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id48" 
id="fixerrors-edit-tools-interpolate" 
name="fixerrors-edit-tools-interpolate">FixErrors Edit Tools: 
Interpolate</a></h5>
<p>One can modify a sequence of frames for a single fly in one step 
using linear interpolation. The "Interpolate Track" tool will replace 
the positions of a selected fly from a start frame to an end frame with 
the linear interpolation between those frames. Follow these steps.</p>
<ol>
<li>Scroll to the first frame of the portion of track to be 
interpolated.</li>
<li>Click on the fly to be interpolated.</li>
<li>Push the "First Frame" button to select.</li>
<li>Scroll to the last frame of the portion of track to be interpolated.</li>
<li>Push the "Do It" button.</li>
</ol>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id49" 
id="fixerrors-edit-tools-extend-track" 
name="fixerrors-edit-tools-extend-track">FixErrors Edit Tools: Extend 
Track</a></h5>
<p>A selected fly's track can be extended in time from the end of its 
track to a selected frame. Follow these steps.</p>
<ol>
<li>Click on the fly to be extended.</li>
<li>Push the "First Fly" button to select it.</li>
<li>Scroll to the last frame to extend until.</li>
<li>Push the "Do It" button.</li>
</ol>
<p>From the end of the fly's trajectory to the selected frame, the fly 
will be set to be in the position in its original last frame.</p>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id50" 
id="fixerrors-edit-tools-auto-track" 
name="fixerrors-edit-tools-auto-track">FixErrors Edit Tools: Auto Track</a></h5>
<p>One can modify a sequence of frames for a single fly in one step 
using the auto-track tool. During auto-tracking, we remove all 
foreground pixels that can be attributed to other flies. Then, we find 
the closest connected component of remaining foreground pixels, and 
store the ellipse fit to this component as the position of the fly. 
There are a few parameters that can be modified in the auto-tracking. 
First, one can fix errors in the background modeling by selecting 
regions of the frame and filling them with a selected color. Second, one
 can set the "Track Radius" -- the size of the square around the fly's 
predicted position that is examined during the tracking. Third, one can 
set the background subtraction threshold. To automatically retrack a fly
 for a sequence of frames:</p>
<div class="figure" style="width: 210px;" align="center">
<a class="reference image-reference" 
href="ctrax_files/ctrax_005.png"><img
 alt="Screenshot of FixErrors Retrack Settings dialog" 
src="ctrax_files/ctrax_005.png" style="width: 200px;"></a>
<p class="caption">Screenshot of FixErrors Retrack Settings dialog.</p>
</div>
<ol>
<li>Click on the fly to be tracked in the frame to be tracked from.</li>
<li>Push the "First Frame" button to select this fly and frame.</li>
<li>If desired, modify the tracking settings by pushing the 
"Settings..." button:</li>
</ol>
<blockquote>
<ol>
<li>The image panel shows the first frame in a window around the 
selected fly's position in that frame. In red, it outlines the connected
 components of foreground pixels detected with the current settings.</li>
<li>To fix the background model, drag a rectangle in the 
"retrack_settings" dialog image. Then, click the "Eyedropper" button, 
and click on the image to select the color to fill the rectangle with. 
Finally, click the "Fill" button.</li>
<li>The window shown reflects the "Track Radius". The "Track Radius" can
 be modified with the corresponding "+" and "-" buttons.</li>
<li>The background subtraction "Threshold" can be modified with the 
corresponding "+" and "-" buttons.</li>
<li>One can specify that the flies are light on a dark background, dark 
on a light background, or other.</li>
<li>Click the "Done" button when finished modifying the tracking 
settings.</li>
</ol>
</blockquote>
<ol start="4">
<li>To see the tracking results as they are computed, select "Show 
Tracking". For faster tracking, deselect it.</li>
<li>Scroll to the frame to be tracked until, then click the "Do It" 
button.</li>
<li>To stop tracking at any time, hit the "Stop" button.</li>
</ol>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id51" 
id="fixerrors-edit-tools-flip-orientation" 
name="fixerrors-edit-tools-flip-orientation">FixErrors Edit Tools: Flip 
Orientation</a></h5>
<p>The head/tail assignment for a selected fly can be flipped for an 
interval (i.e. the fly is rotated by 180 degrees) by following these 
steps:</p>
<ol>
<li>Click on the fly to be flipped in the first frame to by flipped.</li>
<li>Push the "First Frame" button to select.</li>
<li>Scroll to the last frame to be flipped until.</li>
<li>Push the "Do It" button.</li>
</ol>
</div>
<div class="section">
<h5><a class="toc-backref" href="#id52" 
id="fixerrors-edit-tools-auto-track-multiple" 
name="fixerrors-edit-tools-auto-track-multiple">FixErrors Edit Tools: 
Auto Track Multiple</a></h5>
<p>Similar to <a class="reference" 
href="#fixerrors-edit-tools-auto-track">FixErrors Edit Tools: Auto Track</a>,
 we can re-track multiple flies for which the splitting of a single 
connected component into multiple flies has failed. As in <a 
class="reference" href="#fixerrors-edit-tools-auto-track">FixErrors Edit
 Tools: Auto Track</a>, we remove the foreground pixels that can be 
attributed to flies other than those being retracked. We then fit a 
mixture of Gaussians to the remaining foreground pixels, initializing 
with the predicted positions of the flies. This can sometimes perform 
better than the Ctrax tracker, as we are forcing the number of flies fit
 and can use the previous positions of the flies for initialization. As 
with <a class="reference" href="#fixerrors-edit-tools-auto-track">FixErrors
 Edit Tools: Auto Track</a>, there are a few parameters that can be 
modified in the auto-tracking. First, one can fix errors in the 
background modeling by selecting regions of the frame and filling them 
with a selected color. Second, one can set the "Track Radius" -- the 
size of the square around all the flies' predicted positions that is 
examined during the tracking. Third, one can set the background 
subtraction threshold. To automatically retrack a set of flies for a 
sequence of frames:
1. Click on the flies to be tracked in the first frame to be tracked.
2. Push the "First Frame" button to select these flies and frame.
3. If desired, modify the tracking settings by pushing the "Settings..."
 button:</p>
<blockquote>
<ol>
<li>The image panel shows the first frame in a window around the 
selected fly's position in that frame. In red, it outlines the connected
 components of foreground pixels detected with the current settings.</li>
<li>To fix the background model, drag a rectangle in the 
"retrack_settings" dialog image. Then, click the "Eyedropper" button, 
and click on the image to select the color to fill the rectangle with. 
Finally, click the "Fill" button.</li>
<li>The window shown reflects the "Track Radius". The "Track Radius" can
 be modified with the corresponding "+" and "-" buttons.</li>
<li>The background subtraction "Threshold" can be modified with the 
corresponding "+" and "-" buttons.</li>
<li>One can specify that the flies are light on a dark background, dark 
on a light background, or other.</li>
<li>Click the "Done" button when finished modifying the tracking 
settings.</li>
</ol>
</blockquote>
<ol start="4">
<li>To see the tracking results as they are computed, select "Show 
Tracking". For faster tracking, deselect it.</li>
<li>Scroll to the frame to be tracked until, then click the "Do It" 
button.</li>
<li>To stop tracking at any time, hit the "Stop" button.</li>
</ol>
</div>
</div>
</div>
</div>
<hr class="docutils">
<div class="section">
<h2><a class="toc-backref" href="#id53" 
id="behavioralmicroarray-matlab-toolbox" 
name="behavioralmicroarray-matlab-toolbox">BehavioralMicroarray Matlab 
Toolbox</a></h2>
<p>The BehavioralMicroarray Matlab Toolbox contains a number of 
functions for analyzing the behaviors of the walking flies whose 
trajectories are computed using <a class="reference" href="#ctrax">Ctrax</a>.
 The toolbox includes code for computing per-frame statistics such as 
speed, distance to closest fly, ..., code for learning behavior 
classifications, code for detecting learned behaviors in the 
trajectories, code for histogramming various statistics of behavior, and
 code for analyzing and comparing the distributions of behavioral 
statistics for different types of flies. The analyses possible are 
similar to those performed in our paper "High-Throughput Ethomics in 
Large Groups of Drosophila".</p>
<div class="section">
<h3><a class="toc-backref" href="#id54" 
id="behavioralmicroarray-requirements" 
name="behavioralmicroarray-requirements">BehavioralMicroarray 
Requirements</a></h3>
<p>The BehavioralMicroarray toolbox has been tested with Matlab version 
&gt;= 2008a. A license for the <a class="reference" 
href="http://www.mathworks.com/products/statistics/">Matlab Statistics 
Toolbox</a> is also required.</p>
</div>
<div class="section">
<h3><a class="toc-backref" href="#id55" 
id="behavioralmicroarray-installation" 
name="behavioralmicroarray-installation">BehavioralMicroarray 
Installation</a></h3>
<p><strong>Download</strong>:</p>
<ul>
<li>BehavioralMicroarray and FixErrors rely on a common library of 
Matlab helper functions. If you plan to use both the 
BehavioralMicroarray Matlab Toolbox and the <a class="reference" 
href="#fixerrors-matlab-gui">FixErrors Matlab GUI</a>, download the 
latest release of all the Matlab code from <a class="reference" 
href="http://prdownload.berlios.de/ctrax/Ctrax-allmatlab-0.1.04.zip">Ctrax
 Matlab Toolboxes Latest Release</a>.</li>
<li>The latest release of all the Matlab code necessary for the 
BehavioralMicroarray Toolbox (BehavioralMicroarray and Matlab helper 
functions) can be downloaded from <a class="reference" 
href="http://prdownload.berlios.de/ctrax/behavioranalysis-0.1.04.zip">BehavioralMicroarray
 Matlab Toolbox Latest Release</a>.</li>
<li>The latest release of all the Matlab code specific to the 
BehavioralMicroarray toolbox can be downloaded from <a class="reference"
 
href="http://prdownload.berlios.de/ctrax/behavioranalysis-only-0.1.04.zip">BehavioralMicroarray
 Matlab Toolbox Only Latest Release</a>.</li>
<li>The development version of the BehavioralMicroarray and Matlab 
helper code can be checked on using <a class="reference" 
href="http://subversion.tigris.org/">Subversion</a> (see instructions at
 <a class="reference" 
href="http://developer.berlios.de/svn/?group_id=10360">Ctrax SVN 
Instructions</a>). The BehavioralMicroarray code is in the directory <tt>ctrax/trunk/behavioralmicroarray</tt>
 and the Matlab helper functions are in the directory <tt>ctrax/trunk/matlab</tt>.</li>
</ul>
<p>The functions/scripts of interest in the BehavioralMicroarray Toolbox
 are described at <a class="reference" 
href="#behavioralmicroarray-usage">BehavioralMicroarray Usage</a>. To 
run any of these:</p>
<ol>
<li>Unzip the downloaded Matlab code. Note the location of the 
downloaded directory <tt>behavioralmicroarray</tt>.</li>
<li>Start up Matlab.</li>
<li>Change into the <tt>behavioralmicroarray</tt> directory.</li>
<li>Run one of the BehavioralMicroarray scripts by typing its name at 
the command-line. E.g., to run the <cite>showtrx.m</cite> script, type <tt>showtrx</tt>
 at the command-line.</li>
</ol>
</div>
<div class="section">
<h3><a class="toc-backref" href="#id56" id="behavioralmicroarray-usage" 
name="behavioralmicroarray-usage">BehavioralMicroarray Usage</a></h3>
<p>There are a number of Matlab scripts and functions in our Behavior 
Analysis toolbox of interest. This code is currently in the subdirectory
 "matlab/behavioralmicroarray" of the Ctrax repository.</p>
<div class="section">
<h4><a class="toc-backref" href="#id57" id="showtrx-m" name="showtrx-m">showtrx.m</a></h4>
<a class="reference image-reference" 
href="ctrax_files/ctrax_010.png"><div
 class="align-center" align="center"><img alt="Screenshot of showtrx.m" 
class="align-center" src="ctrax_files/ctrax_010.png" style="width: 
400px;"></div>
</a>
<p>This script allows the user to view a movie annotated with the 
trajectories computed by Ctrax. The user first inputs the movie and 
corresponding trajectory mat file. This movie is shown in the main 
window of the GUI that is started. The user can scroll to different 
frames or play the movie. The user can select any number of flies, and 
play the movie keeping the axes zoomed on these flies only. Per-frame 
properties of the last clicked fly are also shown in the "Selected 
Flies" panel. More per-frame statistics can be computed by clicking the 
"Compute Per-Frame Stats" button, which calls the <a class="reference" 
href="#compute-perframe-stats-m">compute_perframe_stats.m</a> script.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id58" id="simple-diagnostics-m" 
name="simple-diagnostics-m">simple_diagnostics.m</a></h4>
<p>This script inputs the trajectories of flies in a video, and outputs a
 few simple visualizations of the data. In figure 1, it plots the (x,y) 
position of each fly in a separate subplot. In figure 2, it plots a 
histogram of the position in the arena of all flies (frequency in the 
left subplot, log frequency in the right subplot). In figure 3, it plots
 a histogram of the speed of all the flies in black as well as each fly 
individually in color. In figure 4, it plots a histogram of the angular 
speed (change in orientation) of all the flies in black as well as each 
fly individually in color.</p>
<a class="reference image-reference" 
href="ctrax_files/ctrax_008.png"><div
 class="align-center" align="center"><img alt="Screenshot of 
simple_diagnostics.m" class="align-center" 
src="ctrax_files/ctrax_008.png" style="width: 400px;"></div>
</a>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id59" id="make-ctrax-results-movie-m" 
name="make-ctrax-results-movie-m">make_ctrax_results_movie.m</a></h4>
<a class="reference image-reference" 
href="ctrax_files/ctrax_003.jpg"><div
 class="align-center" align="center"><img alt="25 female and 25 male 
flies in 24.5-cm diameter open arena." class="align-center" 
src="ctrax_files/ctrax_003.jpg" style="width: 400px;"></div>
</a>
<p>This function makes an AVI out of the raw video of the flies in the 
arena and the trajectories returned by Ctrax/FixErrors like those shown 
in <a class="reference" href="#ctrax-arena-and-video-requirements">Ctrax
 Arena and Video Requirements</a>. The user is prompted for the raw 
video to input, the name of the mat file containing the trajectories, 
and the name of the AVI file to output the annotated movie to. The user 
can then set parameters of which frames to output (first frame and 
number of frames to output), the video frames per second, the compressor
 (Windows only), and the number and size of the zoomed-in fly boxes to 
show in the right panel of the movie.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id60" id="load-tracks-m" 
name="load-tracks-m">load_tracks.m</a></h4>
<p>Usage: <tt>[trx,matname,succeeded] = load_tracks</tt></p>
<p>This function loads in the trajectories output to a mat file by Ctrax
 into the easier-to-use structure <tt>trx</tt>. The <tt>trx</tt> 
structure is the representation of the trajectories used throughout this
 toolbox. It prompts the user for a mat file containing trajectories -- 
this can either be a matfile output by Ctrax or any mat file containing 
the <tt>trx</tt> variable: the output of <a class="reference" 
href="#load-tracks-m">load_tracks.m</a>, <a class="reference" 
href="#convert-units-m">convert_units.m</a>, <a class="reference" 
href="#compute-perframe-stats-m">compute_perframe_stats.m</a>, <a 
class="reference" href="#compute-perframe-stats-social-m">compute_perframe_stats_social.m</a>,
 <a class="reference" href="#classify-by-area-m">classify_by_area.m</a>,
  If the input mat file is the raw output from Ctrax, the function 
stores <tt>trx</tt> to the auto-created file defined by the returned 
value <tt>matname</tt>. The returned value <tt>succeeded</tt> reflects 
whether trajectories were successfully loaded or not. <tt>trx</tt> is an
 array of structs with an element for each fly (i.e. <tt>length(trx)</tt>
 is the number of flies). <tt>trx(fly)</tt> has the following member 
variables.</p>
<ul>
<li><tt>firstframe</tt> is the frame that the trajectory begins on.</li>
<li><tt>endframe</tt> is the frame that the trajectory ends on.</li>
<li><tt>nframes</tt> (<tt>nframes = endframe - startframe + 1</tt>) is 
the length of the trajectory in frames.</li>
<li><tt>x</tt> is a <tt>1 x nframes</tt> array containing the x-position
 of the fly (in pixels) in each frame. Thus, <tt>trx(fly).x(i)</tt> is 
the x-position of <tt>fly</tt> in the <tt>i</tt> th frame of <tt>fly</tt>'s
 trajectory (frame <tt>trx(fly).firstframe + i - 1</tt>).</li>
<li><tt>y</tt> is the <tt>1 x nframes</tt> array of the y-position of <tt>fly</tt>
 in each frame (pixels),</li>
<li><tt>theta</tt> is the <tt>1 x nframes</tt> array of the orientation 
of <tt>fly</tt> in each frame (radians),</li>
<li><tt>a</tt> is the <tt>1 x nframes</tt> array of the quarter-major 
axis length of <tt>fly</tt> in each frame (pixels).</li>
<li><tt>b</tt> is the <tt>1 x nframes</tt> array of the quarter-minor 
axis length of <tt>fly</tt> in each frame (pixels).</li>
</ul>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id61" id="convert-units-m" 
name="convert-units-m">convert_units.m</a></h4>
<p>This script allows a user to convert from the video units of pixels 
and frames to the real units of millimeters and seconds.</p>
<ol>
<li>The user first selects a mat file containing the flies' trajectories
 to convert.</li>
<li>He then sets the number of frames per second.</li>
<li>Next, there is the option to set the conversion from pixels to 
millimeters manually, or to compute this conversion by entering the 
known distance in millimeters between two landmark points.</li>
<li>In the "Compute" option, the user first selects the movie file 
corresponding to the trajectories. The first frame of this movie is then
 read in and displayed.</li>
<li>The user then draws a line between two landmark points.</li>
<li>He then sets the length of this line in millimeters.</li>
<li>Finally, he selects a mat file to save the results to.</li>
</ol>
<p>The resulting <tt>trx</tt> structure (see <a class="reference" 
href="#load-tracks-m">load_tracks.m</a>) is augmented with the following
 member variables:</p>
<ul>
<li><tt>x_mm</tt> is the <tt>1 x nframes</tt> array of x-position in 
millimeters.</li>
<li><tt>y_mm</tt> is the <tt>1 x nframes</tt> array of y-position in 
millimeters.</li>
<li><tt>a_mm</tt> is the <tt>1 x nframes</tt> array of quarter-major 
axis length in millimeters.</li>
<li><tt>b_mm</tt> is the <tt>1 x nframes</tt> array of quarter-minor 
axis length in millimeters.</li>
<li><tt>pxpermm</tt> is the number of pixels per millimeter.</li>
<li><tt>fps</tt> is the number of frames per second.</li>
</ul>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id62" id="compute-perframe-stats-m" 
name="compute-perframe-stats-m">compute_perframe_stats.m</a></h4>
<p>This script inputs the trajectories of flies in a video, and outputs a
 number of per-frame properties of interest. These include per-frame 
speed and acceleration properties such as velocity, angular velocity, 
forward and sideways velocity, velocity direction, change in velocity 
direction, velocity of the nose and tail of the fly, center of rotation,
 speed of center of rotation, acceleration. In addition, there is the 
option to compute arena-based properties for circular arenas, such as 
distance to wall, orientation relative to the wall, change in distance 
to the wall. Finally, there is the option to compute per-frame 
properties involving other flies, such as distance to the closest fly 
(center-center, nose-ellipse), maximum angle of the fly's vision 
subtended by another fly, velocity toward the closest fly, orientation 
and velocity direction relative to closest fly, and change in any of 
these properties. More specifically, the following per-frame properties 
are always computed. All of these fields are appended to the <tt>trx</tt>
 structure.</p>
<p><strong>Basic parameters</strong>:</p>
<ul>
<li><tt>dtheta</tt>: angular velocity (rad/s) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>absdtheta</tt>: angular speed (rad/s) (<tt>|dtheta|</tt>) [<tt>1
 x (nframes - 1)</tt>].</li>
<li><tt>signdtheta</tt>: boolean expressing whether change in 
orientation is positive or negative (no units) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>d2theta</tt>: angular acceleration (rad/s^2) [<tt>1 x (nframes -
 1)</tt>]. Note that <tt>d2theta(1)</tt> is always set to 0, and <tt>d2theta(t)</tt>
 is the acceleration computed from the angular velocities in frames <tt>t</tt>
 and <tt>t + 1</tt>.</li>
<li><tt>absd2theta</tt>: absolute angular acceleration (<tt>|d2theta|</tt>)
 (rad/s^2) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>smooththeta</tt>: orientation, smoothed with the filter <tt>[1,4,6,4,1]/16</tt>
 (rad) [<tt>1 x nframes</tt>].</li>
<li><tt>smoothdtheta</tt>: angular velocity, computed from the smoothed 
orientation (rad/s) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>abssmoothdtheta</tt>: angular speed, computed from the smoothed 
orientation (rad/s) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>smoothd2theta</tt>: angular acceleration, computed from the 
smoothed orientation (rad/s^2) [<tt>1 x (nframes - 1)</tt>]. Note that <tt>smoothd2theta(1)</tt>
 is always set to 0, and <tt>d2theta(t)</tt> is the acceleration 
computed from the angular velocities in frames <tt>t</tt> and <tt>t + 1</tt>.
 * <tt>abssmoothd2theta</tt>: absolute angular acceleration, computed 
from the smoothed orientation (<tt>|smoothd2theta|</tt>)(rad/s^2) [<tt>1
 x (nframes - 1)</tt>].</li>
<li><tt>velmag_ctr</tt>: speed (mm/s) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>du_ctr</tt>: forward velocity of the fly's center (mm/s) [<tt>1 x
 (nframes - 1)</tt>]. This is the projection of the fly's velocity on 
its orientation direction.</li>
<li><tt>dv_ctr</tt>: sideways velocity of the fly's center (mm/s) [<tt>1
 x (nframes - 1)</tt>]. This is the projection of the fly's velocity on 
the direction orthogonal to the orientation. Right is positive, left is 
negative.</li>
<li><tt>corfrac_maj</tt>: projection of the center of rotation on the 
fly's major axis (no units) [<tt>1 x (nframes - 1)</tt>]. This is a 
measure of the point on the fly that translates least from one frame to 
the next. It is 0 at the center of the fly, 1 at the forward tip of the 
major axis, and -1 and the backward tip of the major axis.</li>
<li><tt>corfrac_min</tt>: projection of the center of rotation on the 
fly's minor axis (no units) [<tt>1 x (nframes - 1)</tt>]. This is a 
measure of the point on the fly that translates least from one frame to 
the next. It is 0 at the center of the fly, 1 at the right tip of the 
minor axis, and -1 and the backward tip of the minor axis.</li>
<li><tt>abscorfrac_min</tt>: absolute value of <tt>corfrac_min</tt> (no 
units) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>velmag</tt>: speed of the center of rotation (defined by <tt>corfrac_maj</tt>
 and <tt>corfrac_min</tt>) (mm/s) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>corisonfly</tt>: boolean expressing whether any point on the fly
 does not move (no units) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>du_cor</tt>: forward velocity of the fly's center of rotation 
(defined by <tt>corfrac_maj</tt> and <tt>corfrac_min</tt>) (mm/s) [<tt>1
 x (nframes - 1)</tt>]. This is the projection of the change in the 
position of the center of rotation on the fly onto the fly's orientation
 direction.</li>
<li><tt>dv_cor</tt>: sideways velocity of the fly's center of rotation 
(defined by <tt>corfrac_maj</tt> and <tt>corfrac_min</tt>) (mm/s) [<tt>1
 x (nframes - 1)</tt>]. This is the projection of the change in the 
position of the center of rotation on the fly onto the direction 
orthogonal to the fly's orientation.</li>
<li><tt>absdv_cor</tt>: sideways speed of the fly's center of rotation (<tt>|dv_cor|</tt>)
 (mm/s) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>flipdv_cor</tt>: sideways velocity of the fly's center of 
rotation, sign-normalized so that if the fly's orientation is turning 
right, then <tt>flipdv_cor</tt> is positive if the fly's center of 
rotation is also translating to the right (<tt>dv_cor * signdtheta</tt>)
 (mm/s) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>accmag</tt>: acceleration of the center of rotation (defined by <tt>corfrac_maj</tt>
 and <tt>corfrac_min</tt>) (mm/s^2) [<tt>1 x (nframes - 1)</tt>]. Note 
that <tt>accmag(1)</tt> is always set to 0, and <tt>accmag(t)</tt> is 
the acceleration computed from the velocities in frames <tt>t</tt> and <tt>t
 + 1</tt>.</li>
<li><tt>phi</tt>: velocity direction (rad) [<tt>1 x nframes</tt>].</li>
<li><tt>yaw</tt>: difference between velocity direction and orientation 
(rad) [<tt>1 x nframes</tt>].</li>
<li><tt>absyaw</tt>: absolute difference between velocity direction and 
orientation (rad) [<tt>1 x nframes</tt>].</li>
<li><cite>du_tail</cite>: forward velocity of the backmost point on the 
fly (mm/s) [<tt>1 x (nframes - 1)</tt>]. This is the projection of the 
fly's velocity on its orientation direction.</li>
<li><tt>dv_tail</tt>: sideways velocity of the backmost point on the fly
 (mm/s) [<tt>1 x (nframes - 1)</tt>]. This is the projection of the 
fly's velocity on the direction orthogonal to the orientation. Right is 
positive, left is negative.</li>
<li><tt>absdu_tail</tt>: forward speed of the backmost point on the fly 
(mm/s) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>absdv_tail</tt>: sideways speed of the backmost point on the fly
 (mm/s) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>dtheta_tail</tt>: change in orientation of fly's head around 
mean tail location (rad/s) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>absdtheta_tail</tt>: absolute change in orientation of fly's 
head around mean tail location (rad/s) [<tt>1 x (nframes - 1)</tt>].</li>
<li><tt>phisideways</tt>: difference between velocity direction and 
direction orthogonal to fly's orientation (range is [-pi/2,pi/2)) (rad) 
 [<tt>1 x nframes</tt>].</li>
<li><tt>absphisideways</tt>: absolute difference between velocity 
direction and direction orthogonal to fly's orientation (range is 
[0,pi/2]) (rad)  [<tt>1 x nframes</tt>].</li>
</ul>
<p><strong>Circular arena parameters</strong>:</p>
<ul>
<li><tt>dist2wall</tt>: distance to arena wall (mm) [<tt>1 x nframes</tt>]</li>
<li><tt>theta2wall</tt>: angle to closest point on the arena wall, 
relative to the fly's orientation (rad) [<tt>1 x nframes</tt>].</li>
<li><tt>ddist2wall</tt>: change in distance to arena wall (mm/s) [<tt>1 x
 (nframes-1)</tt>.</li>
<li><tt>absdangle2wall</tt>: absolute value of change in direction to 
closest point on the wall (rad/s) [<tt>1 x (nframes-1)</tt>].</li>
</ul>
<p><strong>Closest fly parameters</strong>:</p>
<ul>
<li><tt>dcenter</tt>: minimum distance between this fly's center and 
other flies' centers (mm) [<tt>1 x nframes</tt>].</li>
<li><tt>closestfly_center</tt>: identity of closest fly, based on 
dcenter [<tt>1 x nframes</tt>].</li>
<li><tt>dnose2ell</tt>: minimum distance between this fly's nose and any
 point on another fly (mm) [<tt>1 x nframes</tt>].</li>
<li><tt>closestfly_nose2ell</tt>: identity of closest fly, based on 
dnose2ell [<tt>1 x nframes</tt>].</li>
<li><tt>dell2nose</tt>: minimum distance between any point on this fly 
and the nose of other flies (mm) [<tt>1 x nframes</tt>].</li>
<li><tt>closestfly_ell2nose</tt>: identity of closest fly, based on 
dell2nose [<tt>1 x nframes</tt>].</li>
<li><tt>anglesub</tt>: maximum total angle of fly's view occluded by 
another fly (rad) [<tt>1 x nframes</tt>]. The fly's view is restricted 
to <tt>[-fov/2,fov/2]</tt>, where <tt>fov</tt> is the set field of view.</li>
<li><tt>closestfly_anglesub</tt>: identity of closest fly, based on 
anglesub [<tt>1 x nframes</tt>].</li>
<li><tt>magveldiff_center</tt>: magnitude of difference in velocity of 
this fly and velocity of closest fly based on dcenter (mm/s) [<tt>1 x 
(nframes-1)</tt>].</li>
<li><tt>magveldiff_nose2ell</tt>: magnitude of difference in velocity of
 this fly and velocity of closest fly based on dnose2ell (mm/s) [<tt>1 x
 (nframes-1)</tt>].</li>
<li><tt>magveldiff_ell2nose</tt>: magnitude of difference in velocity of
 this fly and velocity of closest fly based on dell2nose (mm/s) [<tt>1 x
 (nframes-1)</tt>].</li>
<li><tt>magveldiff_anglesub</tt>: magnitude of difference in velocity of
 this fly and velocity of closest fly based on anglesub (mm/s) [<tt>1 x 
(nframes-1)</tt>].</li>
<li><tt>veltoward_center</tt>: velocity of this fly in direction to 
closest fly based on dcenter (mm/s) [<tt>1 x (nframes-1)</tt>].</li>
<li><tt>veltoward_nose2ell</tt>: velocity of this fly in direction to 
closest fly based on dnose2ell (mm/s) [<tt>1 x (nframes-1)</tt>].</li>
<li><tt>veltoward_ell2nose</tt>: velocity of this fly in direction to 
closest fly based on dell2nose (mm/s) [<tt>1 x (nframes-1)</tt>].</li>
<li><tt>veltoward_anglesub</tt>: velocity of this fly in direction to 
closest fly based on anglesub (mm/s) [<tt>1 x (nframes-1)</tt>].</li>
<li><tt>absthetadiff_center</tt>: absolute difference in orientation 
between this fly and closest fly based on dcenter (rad) [<tt>1 x nframes</tt>].</li>
<li><tt>absthetadiff_nose2ell</tt>: absolute difference in orientation 
between this fly and closest fly based on dnose2ell (rad) [<tt>1 x 
nframes</tt>].</li>
<li><tt>absthetadiff_ell2nose</tt>: absolute difference in orientation 
between this fly and closest fly based on dell2nose (rad) [<tt>1 x 
nframes</tt>].</li>
<li><tt>absthetadiff_anglesub</tt>: absolute difference in orientation 
between this fly and closest fly based on anglesub (rad) [<tt>1 x 
nframes</tt>].</li>
<li><tt>absphidiff_center</tt>: absolute difference in velocity 
direction between this fly and closest fly based on dcenter (rad) [<tt>1
 x (nframes-1)</tt>].</li>
<li><tt>absphidiff_nose2ell</tt>: absolute difference in velocity 
direction between this fly and closest fly based on dnose2ell (rad) [<tt>1
 x (nframes-1)</tt>].</li>
<li><tt>absphidiff_ell2nose</tt>: absolute difference in velocity 
direction between this fly and closest fly based on dell2nose (rad) [<tt>1
 x (nframes-1)</tt>].</li>
<li><tt>absphidiff_anglesub</tt>: absolute difference in velocity 
direction between this fly and closest fly based on anglesub (rad) [<tt>1
 x (nframes-1)</tt>].</li>
<li><tt>absanglefrom1to2_center</tt>: absolute difference between 
direction to closest fly based on dcenter and this fly's orientation 
(rad) [<tt>1 x nframes</tt>].</li>
<li><tt>absanglefrom1to2_nose2ell</tt>: absolute difference between 
direction to closest fly based on dnose2ell and this fly's orientation 
(rad) [<tt>1 x nframes</tt>].</li>
<li><tt>absanglefrom1to2_ell2nose</tt>: absolute difference between 
direction to closest fly based on dell2nose and this fly's orientation 
(rad) [<tt>1 x nframes</tt>].</li>
<li><tt>absanglefrom1to2_anglesub</tt>: absolute difference between 
direction to closest fly based on anglesub and this fly's orientation 
(rad) [<tt>1 x nframes</tt>].</li>
<li><tt>ddcenter</tt>: change in minimum distance between this fly's 
center and other flies' centers (mm/s) [<tt>1 x (nframes-1)</tt>].</li>
<li><tt>ddnose2ell</tt>: change in minimum distance between this fly's 
nose and any point on another fly (mm/s) [<tt>1 x (nframes-1)</tt>].</li>
<li><tt>ddell2nose</tt>: change in minimum distance between any point on
 this fly and the nose of other flies (mm/s) [<tt>1 x (nframes-1)</tt>].</li>
<li><tt>danglesub</tt>: change in maximum total angle of fly's view 
occluded by another fly (rad/s) [<tt>1 x (nframes-1)</tt>].</li>
</ul>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id63" 
id="compute-perframe-stats-social-m" 
name="compute-perframe-stats-social-m">compute_perframe_stats_social.m</a></h4>
<p>Like <a class="reference" href="#compute-perframe-stats-m">compute_perframe_stats.m</a>,
 this script inputs the trajectories of flies in a video and outputs a 
number of per-frame properties of interest. These per-frame properties 
are functions of the trajectories of each pair of flies. Because there 
will be a trajectory computed for each pair of flies, the script saves 
the results to multiple mat files. Each mat file corresponds to the main
 fly <tt>fly1</tt> being a different fly, and the saved trajectory in <tt>pairtrx(fly2)</tt>
 corresponds to the pair <tt>(fly1,fly2)</tt>. The names of each mat 
file are autogenerated, created as the original mat name appended with 
"_perframepairs_fly``[fly1]``_start``[t0]``_end``[t1]``", with <tt>[fly1]</tt>
 standing in for the index of the main fly, <tt>[t0]</tt> standing in 
for the first frame of the pair trajectory and <tt>[t1]</tt> standing in
 for the last frame of the pair trajectory. For example, if <tt>fly1 = 5</tt>,
 <tt>t0 = 1</tt>, and <tt>t1 = 1000</tt>, then we append the mat name 
with "_perframepairs_fly05_start00001_end01000". The per-frame pairwise 
parameters computed are:</p>
<ul>
<li><tt>dcenter</tt>: distance between <tt>fly1</tt> and <tt>fly2</tt>'s
 centers (mm) [<tt>1 x nframes</tt>].</li>
<li><tt>distnose2ell</tt>: distance between <tt>fly1</tt>'s nose and any
 point on <tt>fly2</tt> (mm) [<tt>1 x nframes</tt>].</li>
<li><tt>magveldiff</tt>: magnitude of difference in velocity of <tt>fly1</tt>
 and <tt>fly2</tt>  (mm/s) [<tt>1 x (nframes-1)</tt>].</li>
<li><tt>veltoward</tt>: velocity of <tt>fly1</tt> in direction to <tt>fly2</tt>
 (mm/s) [<tt>1 x (nframes-1)</tt>].</li>
<li><tt>thetadiff</tt>: difference in orientation between <tt>fly2</tt> 
and <tt>fly1</tt> (rad) [<tt>1 x nframes</tt>].</li>
<li><tt>absthetadiff</tt>: absolute difference in orientation between <tt>fly2</tt>
 and <tt>fly1</tt> (rad) [<tt>1 x nframes</tt>].</li>
<li><tt>phidiff</tt>: difference in velocity directions between <tt>fly2</tt>
 and <tt>fly1</tt> (rad)  [<tt>1 x (nframes-1)</tt>].</li>
<li><tt>minvelmag</tt>: minimum <tt>velmag</tt> of <tt>fly1</tt> and <tt>fly2</tt>
 (mm/s) [<tt>1 x (nframes-1)</tt>].</li>
<li><tt>maxvelmag</tt>: maximum <tt>velmag</tt> of <tt>fly1</tt> and <tt>fly2</tt>
 (mm/s) [<tt>1 x (nframes-1)</tt>].</li>
<li><tt>anglefrom1to2</tt>: difference between direction from <tt>fly1</tt>
 to <tt>fly2</tt> and <tt>fly1</tt>'s orientation (rad) [<tt>1 x nframes</tt>].</li>
<li><tt>absanglefrom1to2</tt>: absolute difference between direction 
from <tt>fly1</tt> to <tt>fly2</tt> and <tt>fly1</tt>'s orientation 
(rad) [<tt>1 x nframes</tt>].</li>
<li><tt>danglefrom1to2</tt>: change in direction from <tt>fly1</tt> to <tt>fly2`
 in ``fly1</tt>'s coordinate system.</li>
<li><tt>minabsanglefrom1to2</tt>: minimum absolute angle from <tt>fly1</tt>
 to some point on <tt>fly2</tt> in <tt>fly1</tt>'s coordinate system.</li>
</ul>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id64" id="classify-by-area-m" 
name="classify-by-area-m">classify_by_area.m</a></h4>
<a class="reference image-reference" 
href="ctrax_files/ctrax_029.png"><div
 class="align-center" align="center"><img alt="Screenshot of 
classify_by_area.m" class="align-center" src="ctrax_files/ctrax_029.png"
 style="width: 400px;"></div>
</a>
<p>This script allows one to classify the types of flies in a movie 
based on their areas. For example, it can be used to classify the sex of
 flies, as males are smaller than females.</p>
<ol>
<li>The script first prompts the user for mat files containing the 
trajectories of the flies. Note that the user can enter multiple files 
to classify the types of the flies in more than one movie 
simultaneously.</li>
<li>If an area-based classifier has already been defined during a 
previous run of this script, it can be loaded in at this step by 
choosing the saved mat file containing the parameters of this area-based
 classifier.</li>
<li>The measured image area of the fly will often depend on its location
 in the arena, in particular because of lighting differences. There is 
the option to normalize for this effect by learning the quadratic 
regression that best predicts the area of the fly given its location in 
the arena. For trajectory mat files which may contain more than one type
 of fly, we actually predict the ratio of the area in a particular frame
 to the median area for a fly over the entire trajectory. Better 
performance may be achieved by using homogeneous trajectory files -- 
files where all flies are approximately the same size. Then, we predict 
the ratio of per-frame area to the median area over all frames and 
flies. One can load in more trajectory mat files to optimize these 
normalization parameters, including homogeneous trajectory files, at 
this step. The user can specify whether the extra mat files loaded in 
are homogeneous or not. If they are, then the normalization terms are 
estimated only from these homogeneous mat files, otherwise all mat files
 are used. Also, if the normalization parameters have already been 
estimated, there is an option to load these in from a saved mat file. 
After the normalization parameters have been estimated, a figure will 
pop up showing the normalization function learned -- each pixel in the 
image encodes the fit ratio of area to median area for that location in 
the image.</li>
<li>The script then brings up a figure showing the (possibly normalized)
 median for each area fly over its entire trajectory. The fly identities
 (x-axis) are sorted in order of increasing area (y-axis). The color of 
the plotted point reflects which mat file the fly is from, and a key is 
given in the legend. The for reference, the gray lines give the 5th, 
25th, 75th, and 95th percentile area for the fly over its trajectory. 
The red cross-hairs show the current estimate of the threshold between 
the two types of flies. They can be dragged to move the threshold. To 
select the currently displayed threshold, hit ENTER.</li>
<li>The user must now define the name of the type variable, as well as 
the names of the two types of flies. For instance, the type variable 
might be defined to be "sex", and the smaller type might be defined to 
be "M" (for male) and the larger type might be defined to be "F" (for 
female). In this case, for each fly, the field <tt>sex</tt> would be 
added to the <tt>trx</tt> variable, and its value will be set to either <tt>'M'</tt>
 or <tt>'F'</tt>, depending on the fly's median area.</li>
<li>The updated <tt>trx</tt> variable can then be saved to a mat file. 
The script prompts the user for the names of these files.</li>
<li>The parameters of the area-based classifier can then be saved to a 
mat file for future use.</li>
</ol>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id65" id="learn-params-m" 
name="learn-params-m">learn_params.m</a></h4>
<p>This script allows a user to label the starts and ends of episodes of
 a single behavior. It then learns the threshold-based classifier that 
best replicates these labels.</p>
<ol>
<li>Choose whether to learn a behavior classifier from pre-labeled data 
(i.e. if you have already labeled data, or to label new data.</li>
<li>To label data where the fly is performing and not performing the 
behavior:</li>
</ol>
<a class="reference image-reference" 
href="ctrax_files/ctrax_007.png"><div
 class="align-center" align="center"><img alt="Screenshot of 
labelbehaviors.m" class="align-center" src="ctrax_files/ctrax_007.png" 
style="width: 400px;"></div>
</a>
<p><em>Screencap of labelbehaviors.m function</em></p>
<blockquote>
<ul>
<li>Choose corresponding pairs of movies and mat files containing 
per-frame properties (see <a class="reference" 
href="#compute-perframe-stats-m">compute_perframe_stats.m</a>).</li>
<li>Choose the number of flies to label in each movie, and the number of
 frames to label for each fly labeled. Flies and intervals of frames to 
label are selected randomly from each movie.</li>
<li>Choose the file to save the labels to. If you want to learn 
parameters again from this labeled data using different settings, you 
can load this file instead of relabeling.</li>
<li>A GUI will then open, allowing you to set the start and ends of 
sequences in which the fly is performing the behavior.</li>
<li>The frame of the video currently shown can be moved using the frame 
slider or by clicking on the fly's trajectory.</li>
<li>To add a sequence in which the fly is performing the behavior, go to
 the start of the sequence and hit the "Add Start" button. This will 
highlight the segment starting at the current frame and going to the end
 of the trajectory (or until the start of the next segment).</li>
<li>To set the end of this segment, go to the last frame of the 
behavior, and hit the "Add End" button.</li>
<li>Labeled segments can be removed with the "Delete" button.</li>
<li>You can zoom in and out using the figure toolbar. The small window 
in the top right shows what part of the video is shown in the larger 
main window.</li>
<li>In the bottom panel below the main window, per-frame properties of 
the fly are shown. du_ctr is the forward velocity of the fly's center 
(relative to the fly's orientation, in pixels/frame), dv_ctr is the 
sideways velocity of the fly's center of rotation, dtheta is the change 
in orientation (degrees/frame). cor is the center of rotation along the 
fly's major axis. The center of rotation is defined as the point on the 
fly that translates the least from one frame to the next, and cor is 
this point projected onto the major axis (varies between -1 
corresponding to the tail and 1 corresponding to the nose). du_cor, 
dv_cor are the forward and sideways velocity of the fly's center of 
rotation.</li>
<li>The color of the plotted point is related to the fly's speed [for 
Matlab experts, the "Scatter Command" can be changed to any valid Matlab
 command to change the property encoding the trajectory's color].</li>
<li>When done labeling a fly and its trajectory interval, close the 
window to go to the next fly/movie/finish.</li>
</ul>
</blockquote>
<ol start="3">
<li>Choose a mat file to save the learned parameters to.</li>
</ol>
<a class="reference image-reference" 
href="ctrax_files/ctrax_025.png"><div
 class="align-center" align="center"><img alt="Screenshot of 
chooseproperties.m" class="align-center" src="ctrax_files/ctrax_025.png"
 style="width: 400px;"></div>
</a>
<p><em>Screencap of chooseproperties.m function</em></p>
<ol start="4">
<li>Choose properties of the behavior classifier to learn. The behavior 
classifier is based on four thresholds. The trajectory from from t1 to 
t2 can be classified as the behavior if (i) the per-frame bounds hold: 
in each frame, given properties are within given loose ranges, (ii) the 
near-frame bounds hold: there is a frame within r frames from each frame
 t such that given properties are within given tighter ranges, (iii) the
 sequence sum bounds: the total summed value of given properties over 
the entire sequence must be within given bounds, and (iv) the sequence 
mean bounds: the mean value of a given property over the entire sequence
 must be within given bounds. Within the "chooseproperties" dialog, you 
can select which properties are used for each of the four types of 
bounds. The exact parameter ranges will be learned automatically later, 
but you can also set sensible bounds on the values that these ranges can
 take. For instance, if the property cannot be negative, it is useful to
 bound the ranges at &gt;= 0.</li>
<li>Now that all the parameters have been set, the software will 
automatically try to find the ranges of the bounds that result in the 
segmentation of the training data closest to the labels provided. Figure
 1234 shows the current "Score" of the classifiers considered (higher is
 better). You can hit "Quit" at any time to use the best classifier 
found so far, or wait until the search converges. Properties of the 
current distribution of the classifier parameters and the types of 
classification errors made on the training data are printed out at fixed
 intervals.</li>
<li>The learned parameters have been saved to the file selected in step 
(3). These can be input to a behavior detector.</li>
<li>To illustrate the differences between the detected and labeled 
behaviors, we plot the fly's position in and around frames where either 
the behavior is labeled or detected. The fly's position is plotted in 
black. We plot labeled behaviors in magenta and detected behaviors in 
cyan. At the start and end of each detected behavior, we plot a green 
and red circle, resp. There is a subplot for each labeled fly.We plot 
nothing in cases where no behaviors are labeled or detected.</li>
<li>We finally print out the parameters of the classifier.</li>
</ol>
<a class="reference image-reference" 
href="ctrax_files/ctrax_023.png"><div
 class="align-center" align="center"><img alt="Screenshot of 
learn_params.m output." class="align-center" 
src="ctrax_files/ctrax_023.png" style="width: 400px;"></div>
</a>
<p><em>Screencap of output of learn_params.m</em>.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id66" id="learn-params-social-m" 
name="learn-params-social-m">learn_params_social.m</a></h4>
<p>Similar to the <a class="reference" href="#learn-params-m">learn_params.m</a>
 script, learn_params_social.m allows a user to label the starts and 
ends of episodes of a single social behavior, a behavior involving a 
pair of flies. It then learns the threshold-based classifier that 
operates on a pair of flies' trjaectories and best replicates these 
labels. The following directions parallel the directions in <a 
class="reference" href="#learn-params-m">learn_params.m</a>.</p>
<ol>
<li>Choose whether to learn a behavior classifier from pre-labeled data 
(i.e. if you have already labeled data, or to label new data.</li>
<li>To label data where the fly is performing and not performing the 
behavior:</li>
</ol>
<a class="reference image-reference" 
href="ctrax_files/ctrax_002.png"><div
 class="align-center" align="center"><img alt="Screenshot of 
labelbehaviorssocial.m" class="align-center" 
src="ctrax_files/ctrax_002.png" style="width: 400px;"></div>
</a>
<p><em>Screencap of labelbehaviorssocial.m function</em></p>
<blockquote>
<ul>
<li>Choose corresponding pairs of movies and mat files containing 
per-frame properties (see compute_perframe_stats.m).</li>
<li>Choose the number of flies to label of each sex in each movie, and 
the number of frames to label for each fly labeled (the "sex" property 
should have previously been set using the <a class="reference" 
href="#classify-by-area-m">classify_by_area.m</a> script). Flies and 
intervals of frames to label are selected randomly from each movie.</li>
<li>Choose the file to save the labels to. If you want to learn 
parameters again from this labeled data using different settings, you 
can load this file instead of relabeling.</li>
<li>A GUI will then open, allowing you to set the start and ends of 
behavior sequences, and the other fly involved.</li>
<li>The frame of the video currently shown can be moved using the frame 
slider or by clicking on the fly's trajectory.</li>
<li>The currently selected other fly is highlighted, and a white line is
 drawn from the main fly to the other fly.</li>
<li>To add a sequence in which the fly is performing the behavior, 
select the correct "other fly", go to the start of the sequence, and hit
 the "Add Start" button. This will highlight the segment starting at the
 current frame and going to the end of the trajectory (or until the 
start of the next segment). A colored line will connect the other fly's 
initial position to the labeled trajectory sequence.</li>
<li>To set the end of this segment, go to the last frame of the 
behavior, and hit the "Add End" button.</li>
<li>Labeled segments can be removed with the "Delete" button.</li>
<li>You can zoom in and out using the figure toolbar. The small window 
in the top right shows what part of the video is shown in the larger 
main window.</li>
<li>In the bottom panel below the main window, per-frame properties of 
the fly are shown. du_ctr is the forward velocity of the fly's center 
(relative to the fly's orientation, in pixels/frame), dv_ctr is the 
sideways velocity of the fly's center of rotation, dtheta is the change 
in orientation (degrees/frame). cor is the center of rotation along the 
fly's major axis. The center of rotation is defined as the point on the 
fly that translates the least from one frame to the next, and cor is 
this point projected onto the major axis (varies between -1 
corresponding to the tail and 1 corresponding to the nose). du_cor, 
dv_cor are the forward and sideways velocity of the fly's center of 
rotation.</li>
<li>The color of the plotted point is related to the distance to the 
closest fly [for Matlab experts, the "Scatter Command" can be changed to
 any valid Matlab command to change the property encoding the 
trajectory's color].</li>
<li>When done labeling a fly and its trajectory interval, close the 
window to go to the next fly/movie/finish.</li>
</ul>
</blockquote>
<ol start="3">
<li>Choose a mat file to save the learned parameters to.</li>
<li>Choose properties of the behavior classifier to learn. The behavior 
classifier is based on four thresholds. The trajectory from from t1 to 
t2 can be classified as the behavior if (i) the per-frame bounds hold: 
in each frame, given properties are within given loose ranges, (ii) the 
near-frame bounds hold: there is a frame within r frames from each frame
 t such that given properties are within given tighter ranges, (iii) the
 sequence sum bounds: the total summed value of given properties over 
the entire sequence must be within given bounds, and (iv) the sequence 
mean bounds: the mean value of a given property over the entire sequence
 must be within given bounds. Within the "chooseproperties" dialog, you 
can select which properties are used for each of the four types of 
bounds. The exact parameter ranges will be learned automatically later, 
but you can also set sensible bounds on the values that these ranges can
 take. For instance, if the property cannot be negative, it is useful to
 bound the ranges at &gt;= 0.</li>
<li>Now that all the parameters have been set, the software will 
automatically try to find the ranges of the bounds that result in the 
segmentation of the training data closest to the labels provided. Figure
 1234 shows the current "Score" of the classifiers considered (higher is
 better). You can hit "Quit" at any time to use the best classifier 
found so far, or wait until the search converges. Properties of the 
current distribution of the classifier parameters and the types of 
classification errors made on the training data are printed out at fixed
 intervals.</li>
<li>The learned parameters have been saved to the file selected in step 
(3). These can be input to a behavior detector.</li>
<li>To illustrate the differences between the detected and labeled 
behaviors, we plot the fly's position in and around frames where either 
the behavior is labeled or detected. The main fly is plotted in black, 
the other fly is plotted in green. We connect corresponding frames in 
yellow.We plot labeled behaviors in magenta and detected behaviors in 
cyan. At the start and end of each detected behavior, we plot a green 
and red circle, resp. There is a subplot for each labeled fly.We plot 
nothing in cases where no behaviors are labeled or detected.</li>
<li>We finally print out the parameters of the classifier.</li>
</ol>
<a class="reference image-reference" 
href="ctrax_files/ctrax_004.png"><div
 class="align-center" align="center"><img alt="Screenshot of 
learn_params_social.m output." class="align-center" 
src="ctrax_files/ctrax_004.png" style="width: 600px;"></div>
</a>
<p><em>Screencap of output of learn_params_social.m</em>.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id67" id="detect-behaviors-m" 
name="detect-behaviors-m">detect_behaviors.m</a></h4>
<p>This script uses a defined behavior classifier to segment trajectory 
of each fly (or pair of flies, for social behaviors) into sequences in 
which the fly is and is not performing the given behavior.</p>
<ol>
<li>The user is prompted for the names of mat file(s) containing the 
trajectories of the flies. These mat files should contain all the 
per-frame properties necessary for the behavior detection (see <a 
class="reference" href="#compute-perframe-stats-m">compute_perframe_stats.m</a>
 and <a class="reference" href="#compute-perframe-stats-social-m">compute_perframe_stats_social.m</a>).</li>
<li>The user is prompted for the mat file defining the behavior to be 
classified. This is the output of either <a class="reference" 
href="#learn-params-m">learn_params.m</a> or <a class="reference" 
href="#learn-params-social-m">learn_params_social.m</a>.</li>
<li>If there are missing per-frame parameters in the read-in 
trajectories, the script will try to figure out which functions it must 
call to compute these.</li>
<li>The script then segments each trajectory, and prompts the user for 
the name of the mat file to save the results to. In this mat file, it 
saves the array of structs <tt>seg</tt>, where <tt>seg(fly)</tt> is the 
segmentation for fly <tt>fly</tt>. <tt>seg</tt> has the fields <tt>t1</tt>
 and <tt>t2</tt>, which define the start and end frames of intervals in 
which the fly is performing the behavior.</li>
<li>The segmented trajectories are also plotted in a manner similar to <a
 class="reference" href="#learn-params-m">learn_params.m</a> and <a 
class="reference" href="#learn-params-social-m">learn_params_social.m</a>.
 There is a subplot for each fly. The fly's position in each frame is 
plotted in black. We highlight frames in which the behavior is detected 
in magenta. At the start and end of each detected behavior, we plot a 
green and red circle, resp. In the case of social behaviors, during and 
near detected behaviors, we plot the position of the other fly in green.
 We connect corresponding frames for the main and other fly in yellow.</li>
</ol>
<a class="reference image-reference" 
href="ctrax_files/ctrax_006.png"><div
 class="align-center" align="center"><img alt="Screenshot of 
detect_behaviors.m output." class="align-center" 
src="ctrax_files/ctrax_006.png" style="width: 400px;"></div>
</a>
<p><em>Screencap of output of detect_behaviors.m</em>.</p>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id68" id="histogramproperties-m" 
name="histogramproperties-m">histogramproperties.m</a></h4>
<a class="reference image-reference" 
href="ctrax_files/ctrax.png"><div
 class="align-center" align="center"><img alt="Screenshot of 
histogramproperties.m for one property" class="align-center" 
src="ctrax_files/ctrax.png" style="width: 600px;"></div>
</a>
<p><em>Screencap of histogramproperties.m for one property over four 
different data types.</em></p>
<p>The histogramproperties GUI allows a user to histogram single and 
pairs of per-frame properties. When the GUI is started, the user is 
first prompted for a mat file containing the trajectories with per-frame
 properties. The user can then interact with the GUI to explore 
statistics of the per-frame properties for the flies in the 
trajectories. The "No. Properties" radio buttons allow the user to 
specify whether he wants to histogram a single per-frame property or 
jointly histogram a pair of per-frame properties. In the former case, 
the histogram will consist of the property plotted against frequency. In
 the latter case, a 2-D histogram will be computed and displayed as an 
image, the color of the image reflecting the frequency. The "Property 1"
 and "Property 2" (if two properties are histogrammed) panels allow the 
user to specify which properties to histogram. The pop-up menu displays 
the name of the per-frame property (the actual name of the field of the 
"trx" struct). He can also specify properties of the histogram in this 
panel; the number of bins to histogram into and the range of the data to
 histogram, either in percent or in absolute units. Finally, he can 
specify whether a transformation should be applied to the per-frame data
 before histogramming. "None (Identity)" specifies that no 
transformation should be applied, "Absolute value" specifies that the 
absolute value of the data should be taken, and "Log absolute value" 
specifies that the log of the absolute value should be taken. If the 
loaded in trajectories do not have sufficient per-frame statistics to 
explore, clicking the "Compute Per-Frame Stats" button calls the 
compute_perframe_stats function on the current trajectories.</p>
<p>The user can compare histograms of different portions of the data. 
The Data panel defines different histograms to compute. One can specify a
 behavior segmentation file (computed using <a class="reference" 
href="#detect-behaviors-m">detect_behaviors.m</a>), and look at the 
per-frame properties only during ("During behavior...") or only not 
during ("Invert behavior") the specified behavior. One can look at the 
histogram of the properties during all frames of the behavior, or one 
can condense each sequence of a behavior into a single statistic, then 
histogram these statistics ("Interval Averaging"). "None (Per-frame)" 
specifies that all frames should be used, i.e. there is no summarizing 
of each sequence, and instead the per-frame properties from all 
intervals are just concatenated together. "Interval mean" specifies that
 the mean per-frame property for each interval should be histogrammed. 
"Interval median" indicates that the median per-frame property for each 
interval should be histogrammed. "Interval start" indicates that the 
per-frame property in the first frame of the interval should be 
histogrammed. "Interval end" indicates that the per-frame property in 
the last frame of the interval should be histogrammed. If the <tt>type</tt>
 or <tt>sex</tt> fields of the <tt>trx</tt> struct have been set to 
reflect the type or sex of each fly (e.g. with the <a class="reference" 
href="#classify-by-area-m">classify_by_area.m</a> script), one can also 
separate the flies by type/sex ("Fly Type(s)"). One can set the name of 
this data type in the "Data Name" field.</p>
<p>Properties of the plot can be set in the "Plot Parameters" panel. 
First, one can set precisely what histogram statistic is plotted ("Plot 
Statistic"). "Total Count" is the total frequency over all flies for 
each bin. "Total Fraction" is the total fraction (frequency normalized 
to sum to 1) over all flies. "Mean Fraction per Fly" computes the 
fraction histogram for each fly, then averages the histograms. "Mean 
Count per Fly" computes the frequency histogram for each fly, then 
averages the histograms. Next, one can set whether the standard 
deviation or standard error should be plotted ("Plot Error Bars"). 
Standard deviations/errors are computed over flies. If one selects "Plot
 Individual Flies", the histograms for each individual fly will also be 
plotted, in addition to the population summaries. If "Plot log of 
counts/fraction" is checked, then the log frequencies/fractions are 
plotted.</p>
<a class="reference image-reference" 
href="ctrax_files/ctrax_022.png"><div
 class="align-center" align="center"><img alt="Screenshot of 
histogramproperties.m for two properties" class="align-center" 
src="ctrax_files/ctrax_022.png" style="width: 600px;"></div>
</a>
<p><em>Screencap of histogramproperties.m for two properties and one 
data type.</em></p>
<p>Clicking the "Update Plot" button will update the plotted histogram 
to reflect any changes to the parameters made. Clicking the "Export..." 
button allows the user to export the computed histograms to a selected 
mat file. The following variables are exported:</p>
<ul>
<li><tt>countsperfly</tt>: The frequency histograms for each fly and 
data type. [<tt>nflies x nbins x ndata</tt>].</li>
<li><tt>fracperfly</tt>: The normalized fraction histograms for each fly
 and data type. [<tt>nflies x nbins x ndata</tt>].</li>
<li><tt>propnames</tt>: Name(s) of the per-frame properties 
histogrammed, including transformations performed on the per-frame 
parameters (absolute value, log absolute value, ...).</li>
<li><tt>countstotal</tt>: Frequency histograms for all flies per data 
type [<tt>1 x nbins x ndata</tt>].</li>
<li><tt>countsmean</tt>: Mean of frequency histograms over flies for 
each data type [<tt>1 x nbins x ndata</tt>].</li>
<li><tt>countsstd</tt>: Standard deviation of frequency histograms over 
flies for each data type [<tt>1 x nbins x ndata</tt>].</li>
<li><tt>countsstderr</tt>: Standard error of frequency histograms over 
flies for each data type [<tt>1 x nbins x ndata</tt>].</li>
<li><tt>fractotal</tt>: Normalized fraction histograms over all flies 
per data type [<tt>1 x nbins x ndata</tt>].</li>
<li><tt>fracmean</tt>: Mean of normalized fraction histograms over flies
 for each data type [<tt>1 x nbins x ndata</tt>].</li>
<li><tt>fracstd</tt>: Standard deviation of normalized fraction 
histograms over flies for each data type [<tt>1 x nbins x ndata</tt>].</li>
<li><tt>fracstderr</tt>: Standard error of normalized fraction 
histograms over flies for each data type [<tt>1 x nbins x ndata</tt>].</li>
<li><tt>centers</tt>: Centers of the bins for each property. This is a 
cell with an element for each property (so either a <tt>1 x 1</tt> or <tt>1
 x 2</tt> cell). <tt>centers{propi}</tt> is <tt>1 x nbins</tt>.</li>
<li><tt>props</tt>: Field name(s) of the per-frame properties [<tt>1 x 
nprops</tt> cell].</li>
<li><tt>nbins</tt>: Number of bins for each property [<tt>1 x nprops</tt>].</li>
<li><tt>lb</tt>: Lower bound(s) on per-frame properties histogrammed [<tt>1
 x nprops</tt>].</li>
<li><tt>ub</tt>: Upper bound(s) on per-frame properties histogrammed [<tt>1
 x nprops</tt>].</li>
<li><tt>transforms</tt>: Transformations to the per-frame properties 
before histogramming [<tt>1 x nprops</tt> cell].</li>
<li><tt>isbehavior</tt>: <tt>isbehavior(datai)</tt> indicates whether 
histogram <tt>datai</tt> is restricted to frames during/not during a 
behavior [<tt>1 x ndata</tt>].</li>
<li><tt>segfile</tt>: <tt>segfile{datai}</tt> is the name of the 
behavior segmentation file for histogram <tt>datai</tt> [<tt>1 x ndata</tt>
 cell].</li>
<li><tt>doinvert</tt>: <tt>doinvert(datai)</tt> indicates whether we are
 looking at the per-frame properties not during or during the behavior [<tt>1
 x ndata</tt>].</li>
<li><tt>flytype</tt>: <tt>flytype{datai}</tt> are the type(s) of flies 
that are histogrammed for <tt>datai</tt> [<tt>1 x ndata</tt> cell]. If 
empty, then all fly types are histogrammed.</li>
<li><tt>dataname</tt>: <tt>dataname{datai}</tt> is the name of histogram
 <tt>datai</tt> [<tt>1 x ndata</tt> cell].</li>
</ul>
</div>
<div class="section">
<h4><a class="toc-backref" href="#id69" id="plot-behaviormicroarray-m" 
name="plot-behaviormicroarray-m">plot_behaviormicroarray.m</a></h4>
<p>This script allows the user to explore differences in the behavioral 
statistics of different types of flies. When the GUI is started, the 
user is first prompted to input the name(s) of the trajectory files 
already augmented with the per-frame properties. The user can then 
interact with the GUI to plot and compare various behavioral statistics 
for different populations of flies.</p>
<a class="reference image-reference" 
href="ctrax_files/ctrax_019.png"><div
 class="align-center" align="center"><img alt="Screenshot of 
plotbehaviormicroarray.m parameter settings." class="align-center" 
src="ctrax_files/ctrax_019.png" style="width: 400px;"></div>
</a>
<ul>
<li>The <em>Trajectories</em> panel shows the <tt>trx</tt> mat files 
currently loaded in. These can be modified with the "Add..." and 
"Delete" buttons.</li>
<li>The <em>Behaviors</em> panel shows the behaviors currently loaded 
in. To load in a behavior, one must associate a behavior segmentation 
file (the output of <a class="reference" href="#detect-behaviors-m">detect_behaviors.m</a>)
 with each trajectory file listed in the "Trajectories" panel. A new 
behavior can be added with the "Add..." button. This will go through 
each <tt>trx</tt> file and prompt the user for the associated 
segmentation file. Once the segmentation files have been defined, the 
user can edit the name of the behavior. The currently displayed behavior
 can be changed using the drop-down menu with the names of all the 
behaviors. The user can change the segmentation file associated with a 
specific trx file by selecting that segmentation file and clicking the 
"Edit..." button. Note that the selected trx file in the "Trajectories" 
panel corresponds to the selected segmentation file.</li>
<li>The <em>Populations</em> panel allows the user to define different 
populations of flies to be compared. A fly type consists of subsets of 
the trx files and <tt>sex</tt> and <tt>type</tt> fields of <tt>trx</tt>.
 The <tt>sex</tt> and <tt>type</tt> fields can be set, for instance, 
using the <a class="reference" href="#classify-by-area-m">classify_by_area.m</a>
 script. A new population can be defined by clicking the "Add New" 
button. The types and trx files associated with the current population 
can be selected using the listbox. The population currently displayed 
can be changed with the drop-down menu. The name of the population can 
be set in the edit box. The current population definition can be removed
 with the "Delete" button.</li>
<li><p>The behavioral statistics to be plotted are set in the 
"Properties" panel. The drop-down menu allows the user to select the 
currently displayed property. The text edit box allows the user to set 
the name of this property. The current property may be associated with a
 behavior, selectable by behavior name using the drop-down menu. The 
property may be one of the following, selectable using the radio 
buttons:</p>
<ul>
<li><em>Duration</em>: The mean duration of bouts of the associated 
behavior for the fly.</li>
<li><em>Fraction of time</em>: The fraction of time the fly performs the
 associated behavior.</li>
<li><em>Frequency</em>: The frequency of onsets of the associated 
behavior for the fly.</li>
<li><em>Per-frame props</em>: The average value of a per-frame property 
(as computed by <a class="reference" href="#compute-perframe-stats-m">compute_perframe_stats.m</a>
 or <a class="reference" href="#compute-perframe-stats-social-m">compute_perframe_stats_social.m</a>).
 The per-frame property is set in the "Per-Frame Property" panel, 
visible only if "Per-frame props" is selected.</li>
</ul>
</li>
<li>In the "Per-Frame Property" panel, the drop-down menu allows the 
user to select the per-frame property (as computed by <a 
class="reference" href="#compute-perframe-stats-m">compute_perframe_stats.m</a>
 or <a class="reference" href="#compute-perframe-stats-social-m">compute_perframe_stats_social.m</a>
 script) the current property is based on. The radio buttons allow the 
user to select whether the property is averaged over only frames during 
the associated behavior ("During behavior"), not during the associated 
behavior ("Not during behavior"), or over all frames ("All frames"). If 
the per-frame property is during or not during behaviors, then one may 
prefer to represent each bout of the behavior or non-behavior with a 
single statistic, then average the statistics over bouts. The "Interval 
averaging" drop-down menu allows one to specify this. If "None 
(per-frame)" is selected, then the average per-frame property over all 
relevant frames is computed. If "Interval mean"/"Interval median" is 
selected, then the mean/median per-frame property per bout is computed 
and averaged over all bouts. If "Interval start"/"Interval end" is 
selected, then the per-frame property at the start/end of the bout is 
averaged over all bouts. A new property can be defined with the "Add 
new" button, and the currently displayed property definition can be 
removed with the "Delete" button.</li>
</ul>
<a class="reference image-reference" 
href="ctrax_files/ctrax_020.png"><div
 class="align-center" align="center"><img alt="Screenshot of property 
means per population output by plotbehaviormicroarray.m." 
class="align-center" src="ctrax_files/ctrax_020.png" style="width: 
600px;"></div>
</a>
<p><em>Screenshot of means per population output by 
plotbehaviormicroarray.m.</em></p>
<a class="reference image-reference" 
href="ctrax_files/ctrax_021.png"><div
 class="align-center" align="center"><img alt="Screenshot of per-fly 
behavioral microarray output by plotbehaviormicroarray.m." 
class="align-center" src="ctrax_files/ctrax_021.png" style="width: 
600px;"></div>
</a>
<p><em>Screenshot of per-fly behavioral microarray output by 
plotbehaviormicroarray.m.</em></p>
<ul>
<li>The <em>Plot</em> panel allows the user to control properties of the
 plots. In the first figure, we plot the mean of each property over all 
flies in each population. Thus, we can compare the properties over 
population. Error bars may also be plotted, indicating either the 
population standard deviation or standard error ("Error bars" drop-down 
menu). If "Normalize per-prop" is selected, then the total population 
statistics are shown in the top subplot, and in the bottom subplot we 
plot the number of standard deviations each population is from the total
 population mean. This is often useful as the differences in values 
between different properties may be much larger than differences between
 different populations. If "Plot individuals" is selected, then the 
properties for each individual fly is plotted. If "Normalize per-prop" 
is selected, then we plot the z-scored properties (the number of 
standard deviations from the mean for all flies). In the second figure, 
we show the "behavioral microarray". We draw an image for each 
population of flies. Each row in the image corresponds to a different 
property and each column to an individual fly. The color of the pixel 
for a given property and fly is related to the value of that property, 
or the normalized value of that property if "Normalize per-prop" is 
selected. Clicking "Update Plot" updates the two figures to reflect the 
current settings.</li>
<li>The properties shown can also be selected automatically selected to 
best differentiate the populations. If more than one population is 
defined, then the properties which maximize a variant of <a 
class="reference" 
href="http://en.wikipedia.org/wiki/Linear_discriminant_analysis#Fisher.27s_linear_discriminant">Fisher's
 linear discriminant</a> are selected. More specifically, if mu_i is the
 mean for population i and sigma_i is the standard deviation for 
population i, we choose the properties that maximize</li>
</ul>
<div class="align-center" align="center"><img 
alt="tex:\frac{\sum_{(i,j)} (\mu_i - \mu_j)^2}{\sum_i \sigma_i^2}" 
class="align-center" src="ctrax_files/ctrax_002.jpg" style="width: 
150px;"></div>
<ul>
<li>If "Choose independently" is selected, then we choose the top 
properties. If it is not selected, we greedily choose the best property,
 remove the correlations between the chosen properties and the remaining
 property, then choose the property whose residual has the highest 
discriminative power. If there is only one population of flies, then 
properties are chosen so that flies cluster into two groups. For every 
nearly-even split of flies (at least 30% of flies must be in one group),
 we compute the Fisher linear discriminant. We choose the properties 
with maximal maximum discrimant over all allowed splits. As with 
multiple types of flies, if "Choose independently" is selected, we 
choose the top properties independently. If it is not selected, then we 
remove correlations with previously chosen properties before choosing 
again.</li>
<li>There are a large number of potential properties to choose from, and
 it may be useful to restrict those under consideration by the 
auto-choose program. The allowed properties can be manipulated in the 
"Auto-choose" panel. The total number of available properties to choose 
from is shown.</li>
</ul>
</div>
</div>
</div>
<hr class="docutils">
<div class="section">
<h2><a class="toc-backref" href="#id70" 
id="ctrax-matlab-toolboxes-installation" 
name="ctrax-matlab-toolboxes-installation">Ctrax Matlab Toolboxes 
Installation</a></h2>
<p>If you plan to use both the <a class="reference" 
href="#fixerrors-matlab-gui">FixErrors Matlab GUI</a> and the <a 
class="reference" href="#behavioralmicroarray-matlab-toolbox">BehavioralMicroarray
 Matlab Toolbox</a>, you can download all the Matlab code from <a 
class="reference" 
href="http://prdownload.berlios.de/ctrax/Ctrax-allmatlab-0.1.04.zip">Ctrax
 Matlab Toolboxes Latest Release</a>. To install, just unzip the package
 and note the locations of the <tt>fixerrors</tt> and <tt>behavioralmicroarray</tt>
 subdirectories. Follow instructions above at <a class="reference" 
href="#fixerrors-installation">FixErrors Installation</a> and <a 
class="reference" href="#behavioralmicroarray-installation">BehavioralMicroarray
 Installation</a>.</p>
</div>
<hr class="docutils">
<div class="section">
<h2><a class="toc-backref" href="#id71" id="contact" name="contact">Contact</a></h2>
<p>For questions or suggestions about the Ctrax software suite, please 
post to the <a class="reference" 
href="http://groups.google.com/group/ctrax">Ctrax Google Group</a>. For 
other inquiries, contact corresponding author <a class="reference" 
href="http://www.hhmi.org/research/fellows/branson.html">Kristin Branson</a>.</p>
<hr class="docutils">
</div>

</div>



</body></html>
